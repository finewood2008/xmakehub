<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMAKEHUB AIé€ ç‰©æ‰€ - ä»Promptåˆ°Product</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --tech-blue: #0ea5e9; /* sky-500 */
            --vibrant-orange: #f97316; /* orange-500 */
            --dark-bg: #0c112b; /* A dark navy blue */
            --card-bg: rgba(22, 29, 63, 0.5); 
            --border-color: rgba(56, 189, 248, 0.2);
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--dark-bg);
            color: #d1d5db; /* gray-300 */
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 25px 25px;
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .gradient-text {
            background: linear-gradient(90deg, var(--tech-blue) 0%, var(--vibrant-orange) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .loader, .prompt-loader {
            border: 4px solid #374151; /* gray-700 */
            border-top: 4px solid var(--tech-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .prompt-loader { width: 16px; height: 16px; border-width: 2px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }

        #chat-window { 
            height: calc(100vh - 300px);
            overflow-y: auto;
        }
        #demo-chat-window { 
            height: 200px; 
            overflow-y: auto; 
        }
        .chat-bubble { max-width: 90%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }
        .user-bubble { background-color: var(--tech-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-bubble { background-color: #374151; /* gray-700 */ color: #d1d5db; align-self: flex-start; border-bottom-left-radius: 4px; }
        .ai-bubble strong { color: var(--tech-blue); }
        
        .prose { color: #d1d5db; }
        .prose h1, .prose h2 { color: white; border-bottom: 1px solid #4b5563; padding-bottom: 0.5em; margin-bottom: 1em; }
        .prose h3, .prose h4, .prose h5, .prose h6 { color: #93c5fd; margin-top: 2em; margin-bottom: 1em; }
        .prose strong { color: var(--tech-blue); }
        .prose ul > li::before { background-color: var(--tech-blue); }
        .prose p, .prose ul, .prose ol { line-height: 1.7; }
        .prose hr { border-color: #4b5563; }

        .step-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 5rem;
            height: 5rem;
            background-color: rgba(255, 255, 255, 0.05);
            color: #6b7280;
            border-radius: 50%;
            font-size: 1.875rem;
            margin-bottom: 1rem;
            border: 2px solid #374151;
            transition: all 0.3s ease-in-out;
            position: relative;
        }
        .step-icon.active {
            background-color: var(--tech-blue);
            color: white;
            border-color: var(--tech-blue);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); }
            50% { box-shadow: 0 0 35px 10px rgba(249, 115, 22, 0.7); }
        }
        .step-icon.emphasized {
            background-color: var(--vibrant-orange);
            color: white;
            border-color: var(--vibrant-orange);
            animation: pulse 2s infinite;
        }
        .step-link { cursor: pointer; }
        
        .emotion-choice {
            cursor: pointer;
            font-size: 1.75rem;
            transition: all 0.2s ease-in-out;
            padding: 4px;
            border-radius: 8px;
        }
        .emotion-choice:hover {
            transform: scale(1.25);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .prompt-generator-icon {
            cursor: pointer;
            color: #f97316;
            margin-left: 0.5rem;
            transition: transform 0.2s;
        }
        .prompt-generator-icon:hover {
            transform: scale(1.2);
        }
        
    </style>
</head>
<body class="min-h-screen">
    
    <!-- ä¸»è§†å›¾ -->
    <div id="main-view" class="view active">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10">
            <div class="container mx-auto px-4 py-4">
                <div class="text-xl font-bold text-white"><i class="fas fa-atom mr-2 gradient-text"></i>XMAKEHUB <span class="gradient-text">AIé€ ç‰©æ‰€</span></div>
            </div>
        </nav>
        <main class="container mx-auto px-4 py-6">
            <!-- è‹±é›„åŒº -->
            <section class="text-center py-12 md:py-16 rounded-2xl">
                <h1 class="text-5xl md:text-7xl font-black mb-4 text-white">AIé€ ç‰©æ‰€</h1>
                <p class="text-lg md:text-xl text-slate-300 max-w-3xl mx-auto mb-6 font-semibold">ç”¨ä¸€å¥è¯æ‰“é€ ä¸€æ¬¾AIç¡¬ä»¶ï¼Œ<span class="gradient-text">ä» Prompt åˆ° Product</span></p>
                <p class="text-base text-slate-400 max-w-2xl mx-auto mb-8">åœ¨è¿™é‡Œï¼Œæ‚¨çš„ä»»ä½•ä¸€ä¸ªç¡¬ä»¶æ„æƒ³ï¼Œéƒ½èƒ½é€šè¿‡ä¸æˆ‘ä»¬å…ˆè¿›çš„ AI äº§å“ç»ç†æ·±åº¦åä½œï¼Œä»ä¸€ä¸ªæ¨¡ç³Šçš„å¿µå¤´ï¼Œä¸€æ­¥æ­¥å˜ä¸ºè¯¦å°½çš„è§„æ ¼ã€é€¼çœŸçš„åŸå‹ï¼Œç›´è‡³æœ€ç»ˆçš„å•†ä¸šè¯„ä¼°ã€‚</p>
                <div>
                    <a href="#creation-process" id="start-creation-link" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg shadow-sky-500/30 transform hover:scale-105 transition-transform">ç«‹å³å¼€å¯ <i class="fas fa-rocket ml-2"></i></a>
                </div>
            </section>

            <!-- å®ç°æµç¨‹ -->
            <section id="how-it-works" class="py-12">
                <h2 class="text-3xl font-bold text-center mb-12 text-white">å®ç°æµç¨‹</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-8 text-center relative">
                    <!-- Dashed line connector for desktop -->
                    <div class="hidden md:block absolute top-1/2 left-0 w-full h-px" style="transform: translateY(-5rem);">
                         <svg width="100%" height="2" class="absolute top-1/2 left-0" style="transform: translateY(-50%);">
                            <line x1="10%" y1="1" x2="90%" y2="1" stroke-width="2" stroke-dasharray="8 8" class="stroke-slate-600"/>
                        </svg>
                    </div>
                    <a id="step-link-1" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-1" class="step-icon"><i class="fas fa-lightbulb"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">1. æå‡ºæ„æƒ³</h3>
                        <p class="text-slate-400 text-sm">ç”¨ä¸€å¥è¯æè¿°æ‚¨çš„äº§å“çµæ„Ÿã€‚</p>
                    </a>
                    <a id="step-link-2" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-2" class="step-icon"><i class="fas fa-comments"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">2. AIæ·±åº¦å¯¹è¯</h3>
                        <p class="text-slate-400 text-sm">ä¸AIäº§å“ç»ç†æ²Ÿé€šï¼Œæ˜ç¡®ç»†èŠ‚ã€‚</p>
                    </a>
                    <a id="step-link-3" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-3" class="step-icon"><i class="fas fa-file-alt"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">3. ç”ŸæˆPRDæ–‡æ¡£</h3>
                        <p class="text-slate-400 text-sm">ä¸€é”®ç”Ÿæˆä¸“ä¸šçš„äº§å“éœ€æ±‚æ–‡æ¡£ã€‚</p>
                    </a>
                    <a id="step-link-4" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-4" class="step-icon emphasized"><i class="fas fa-vr-cardboard"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">4. æ²‰æµ¸å¼ä½“éªŒ</h3>
                        <p class="text-slate-400 text-sm">ä½“éªŒåŸå‹ã€ç”Ÿæˆæ¸²æŸ“å›¾ã€‚</p>
                    </a>
                    <a id="step-link-5" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-5" class="step-icon"><i class="fas fa-tags"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">5. åŸå‹æŠ¥ä»·</h3>
                        <p class="text-slate-400 text-sm">è·å–ç”Ÿäº§æŠ¥ä»·å¹¶å¯åŠ¨é¡¹ç›®ã€‚</p>
                    </a>
                </div>
            </section>
            
            <section id="creation-process" class="glass-card p-6 md:p-8 mt-8">
                 <h2 class="text-3xl font-bold mb-6 flex items-center text-white"><span class="ml-4">æå‡ºæ‚¨çš„åˆæ­¥æ„æƒ³</span></h2>
                 <textarea id="initial-idea-input" class="w-full h-32 p-4 border bg-slate-800 border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="è¯·ç®€å•æè¿°æ‚¨çš„äº§å“æ„æƒ³ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³å¼€å‘ä¸€æ¬¾å¸¦AIåŠŸèƒ½çš„æ™ºèƒ½å’–å•¡æœº..."></textarea>
                 <div class="mt-4 flex justify-center">
                     <button id="start-chat-button" class="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-medium py-3 px-8 rounded-lg transition-colors flex items-center justify-center">å¼€å§‹ä¸AIäº§å“ç»ç†å¯¹è¯ <i class="fas fa-comments ml-2"></i></button>
                 </div>
            </section>
        </main>
        <footer class="bg-slate-900/50 text-white py-12 mt-16">
            <div class="container mx-auto px-4 text-center text-slate-400"><p>Â© 2025 XMAKEHUB AIé€ ç‰©æ‰€. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p></div>
        </footer>
    </div>
    
    <!-- å¯¹è¯è§†å›¾ -->
    <div id="chat-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-xl font-bold text-white"><i class="fas fa-comments mr-2 gradient-text"></i>ä¸ AI äº§å“ç»ç†å¯¹è¯</div><button id="back-to-main-from-chat" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>è¿”å›é¦–é¡µ</button></div></nav>
        <main class="container mx-auto p-4">
             <div class="border border-slate-700 rounded-lg p-4 flex flex-col glass-card">
                <div id="chat-window" class="flex flex-col gap-4 mb-4 pr-2"></div>
                <div id="ai-thinking-indicator" class="hidden flex items-center gap-3 self-start my-2"><div class="ai-bubble loader !p-3"></div><p class="text-slate-400 text-sm">æ­£åœ¨è¾“å…¥...</p></div>
                <div class="pt-4 border-t border-slate-700 mt-2">
                     <div class="flex items-center gap-3">
                        <input id="chat-input" type="text" class="flex-grow w-full p-3 border bg-slate-800 border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„æƒ³æ³•æˆ–å›ç­”...">
                        <button id="send-chat-button" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-lg transition-colors flex items-center justify-center">å‘é€ <i class="fas fa-paper-plane ml-2"></i></button>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-center"><button id="finish-chat-button" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg transition-colors">éœ€æ±‚å·²æ˜ç¡®ï¼Œç”ŸæˆPRDæ–‡æ¡£ <i class="fas fa-file-alt ml-2"></i></button></div>
        </main>
    </div>

    <!-- PRD è§†å›¾ -->
    <div id="prd-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-xl font-bold text-white"><i class="fas fa-file-alt mr-2 gradient-text"></i>äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)</div><button id="back-to-chat" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>è¿”å›å¯¹è¯</button></div></nav>
        <main class="container mx-auto p-4">
             <div class="glass-card p-6 md:p-8">
                 <div id="generated-prd" contenteditable="true" class="p-6 bg-slate-900 rounded-lg border border-slate-700 prose max-w-none focus:ring-2 focus:ring-sky-500 min-h-[50vh]"></div>
                 <div id="prd-actions" class="flex flex-wrap gap-4 mt-6">
                     <button id="generate-user-stories-button" class="bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-users mr-2"></i>ç”Ÿæˆç”¨æˆ·æ•…äº‹</button>
                     <button id="generate-bom-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-microchip mr-2"></i>ç”Ÿæˆç‰©æ–™æ¸…å• (BOM)</button>
                     <button id="analyze-market-button" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-chart-line mr-2"></i>åˆ†æå¸‚åœºæ½œåŠ›</button>
                     <button id="export-pdf-button" class="bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-file-pdf mr-2"></i>å¯¼å‡ºä¸ºPDF</button>
                 </div>
                 <h2 class="text-2xl font-bold mt-12 mb-6 flex items-center text-white"><span class="ml-4">ä¸‹ä¸€æ­¥ï¼šæ²‰æµ¸å¼ä½“éªŒ</span></h2>
                 <p class="text-slate-400 mb-4">è¿›å…¥ä¸€ä¸ªå…¨æ–°çš„æ²‰æµ¸å¼ä½“éªŒä¸­å¿ƒï¼Œå°†æ‚¨çš„æ„æƒ³åŒ–ä¸ºç°å®ï¼Œå¹¶è·å–æŠ¥ä»·ã€‚</p>
                 <button id="go-to-experience-view-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-8 rounded-lg transition-colors text-lg">è¿›å…¥ä½“éªŒä¸æŠ¥ä»·ä¸­å¿ƒ <i class="fas fa-vr-cardboard ml-2"></i></button>
            </div>
        </main>
    </div>

    <!-- ä½“éªŒä¸åŸå‹è§†å›¾ -->
    <div id="experience-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-xl font-bold text-white"><i class="fas fa-atom mr-2 gradient-text"></i>åŸå‹ä½“éªŒä¸æŠ¥ä»·ä¸­å¿ƒ</div><button id="back-to-prd" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>è¿”å›PRD</button></div></nav>
        <main class="container mx-auto px-4 py-8">
            <div id="experience-prototype-page">
                <h2 class="text-3xl font-bold mb-8 text-center text-white">4. æ²‰æµ¸å¼ä½“éªŒ</h2>
                
                <section class="glass-card p-6 md:p-8">
                    <!-- Top: Large Image Frame -->
                    <div id="immersive-image-container" class="w-full max-w-4xl mx-auto bg-slate-900 rounded-lg p-4 relative aspect-[16/9] flex items-center justify-center border border-slate-700 mb-8">
                        <div id="scene-image-loader" class="hidden absolute inset-0 bg-slate-900/80 flex-col items-center justify-center rounded-lg">
                            <div class="loader"></div>
                            <p class="mt-4 text-slate-400">AI æ­£åœ¨å…¨åŠ›ç»˜å›¾ä¸­...</p>
                        </div>
                        <img id="scene-product-image" src="https://placehold.co/1792x1024/0f172a/9ca3af?text=äº§å“æ•ˆæœå›¾" alt="äº§å“æ•ˆæœå›¾" class="max-w-full max-h-full object-contain rounded" onerror="this.onerror=null;this.src='https://placehold.co/1792x1024/e2e8f0/334155?text=å›¾ç‰‡åŠ è½½å¤±è´¥';">
                    </div>

                    <!-- Middle: Dialogue Simulator and Emotion Screen -->
                    <div class="flex flex-col md:flex-row gap-8 mb-8">
                        <div class="flex-grow">
                            <h4 class="font-semibold text-lg mb-4 text-white">äº§å“AIå¯¹è¯æ¨¡æ‹Ÿå™¨</h4>
                            <div class="border border-slate-700 rounded-lg p-4 flex flex-col bg-slate-900/50 h-full">
                                <div id="demo-chat-window" class="flex flex-col gap-4 mb-4 pr-2 flex-grow"></div>
                                <div id="demo-ai-thinking-indicator" class="hidden flex items-center gap-3 self-start mt-2"><div class="ai-bubble loader !p-3"></div><p class="text-slate-400 text-sm">æ­£åœ¨è¾“å…¥...</p></div>
                                <div class="flex items-center gap-3 pt-4 border-t border-slate-700 mt-4">
                                    <input id="demo-chat-input" type="text" class="flex-grow w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white" placeholder="ä¸æ‚¨çš„AIåŠ©æ‰‹å¯¹è¯...">
                                    <button id="demo-send-chat-button" class="bg-sky-500 hover:bg-sky-600 text-white font-medium p-3 rounded-lg flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-1/5 flex flex-col items-center flex-shrink-0">
                            <h4 class="font-semibold text-lg mb-4 text-white">AI æƒ…ç»ª</h4>
                             <div id="emotion-screen" class="w-full aspect-square bg-slate-900 rounded-2xl flex items-center justify-center text-7xl shadow-inner border border-slate-700 mb-4">
                                 ğŸ™‚
                             </div>
                             <div id="emotion-selector" class="flex flex-wrap gap-3 justify-center">
                                <!-- è¡¨æƒ…ç¬¦å·å°†ç”±JSåŠ¨æ€å¡«å…… -->
                             </div>
                        </div>
                    </div>
                    
                    <!-- Bottom: Prompt Controls -->
                     <hr class="my-8 border-slate-700"/>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <div>
                            <label for="persona-textarea" class="block text-slate-300 font-semibold mb-2">AIè®¾å®š</label>
                            <textarea id="persona-textarea" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 text-white"></textarea>
                            <button id="apply-persona-button" class="w-full mt-2 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-6 rounded-lg">åº”ç”¨è§’è‰²å¹¶å¼€å§‹å¯¹è¯</button>
                         </div>
                         <div>
                             <div class="flex items-center mb-2">
                                <label for="appearance-keyword-textarea" class="block text-slate-300 font-semibold">äº§å“å¤–è§‚è®¾å®š</label>
                                <span id="open-prompt-helper" class="prompt-generator-icon ml-2" title="AIæç¤ºè¯åŠ©æ‰‹"><i class="fas fa-lightbulb"></i></span>
                             </div>
                             <textarea id="appearance-keyword-textarea" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white"></textarea>
                             <button id="generate-appearance-button" class="w-full mt-2 bg-sky-500 hover:bg-sky-600 text-white font-medium py-3 px-6 rounded-lg">ç”Ÿæˆäº§å“æ•ˆæœå›¾</button>
                         </div>
                     </div>
                </section>
                
                <div class="text-center mt-12"><button id="go-to-quotation-button" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg text-lg">ä¸‹ä¸€æ­¥ï¼šåŸå‹ç”Ÿäº§ä¸æŠ¥ä»· <i class="fas fa-arrow-right ml-2"></i></button></div>
            </div>
            <div id="experience-quotation-page" class="hidden">
                 <h2 class="text-3xl font-bold mb-6 flex items-center text-white"><span class="ml-4">5. è·å–ä¸“ä¸šæŠ¥ä»·</span></h2>
                 <div class="glass-card p-6 md:p-8">
                     <div id="quotation-form-container">
                         <h3 class="text-2xl font-bold mb-4 text-white">æœ€ç»ˆç¡®è®¤ä¸æäº¤</h3>
                         <p class="text-slate-400 mb-6">è¯·åœ¨ä¸‹æ–¹è¡¥å……æ‚¨çš„æœ€ç»ˆéœ€æ±‚ã€‚æäº¤åï¼Œæˆ‘ä»¬ä¼šå°†æ‰€æœ‰é¡¹ç›®èµ„æ–™ï¼ˆPRDã€æ•ˆæœå›¾ã€AIè®¾å®šåŠè¡¥å……è¯´æ˜ï¼‰æ‰“åŒ…ï¼Œæˆ‘ä»¬çš„é¡¹ç›®é¡¾é—®å°†å°½å¿«ä¸æ‚¨è”ç³»å¹¶æä¾›æŠ¥ä»·ã€‚</p>
                         <form id="quotation-form">
                            <div class="mb-6">
                                <label for="user-additional-requirements" class="block text-slate-300 font-semibold mb-2">éœ€æ±‚è¡¥å……è¯´æ˜</label>
                                <textarea id="user-additional-requirements" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="æ‚¨å¯ä»¥åœ¨æ­¤è¾“å…¥ä»»ä½•é¢å¤–çš„éœ€æ±‚ã€è§„æ ¼æˆ–ç‰¹æ®Šè¯´æ˜..."></textarea>
                            </div>
                             <div class="mb-4">
                                <label for="user-email" class="block text-slate-300 font-semibold mb-2">é‚®ç®±åœ°å€</label>
                                <input type="email" id="user-email" class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="example@email.com" required>
                            </div>
                             <div class="mb-6">
                                <label for="user-contact" class="block text-slate-300 font-semibold mb-2">å…¶ä»–è”ç³»æ–¹å¼ (ç”µè¯, å¾®ä¿¡ç­‰)</label>
                                <input type="text" id="user-contact" class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="æ‚¨çš„ç”µè¯å·ç æˆ–å¾®ä¿¡å·">
                            </div>
                             <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg text-lg">æäº¤é¡¹ç›®ä»¥è·å–æŠ¥ä»·</button>
                         </form>
                     </div>
                     <div id="quotation-success-message" class="hidden text-center py-10">
                          <div class="text-6xl text-green-500 mb-4"><i class="fas fa-check-circle"></i></div>
                          <h3 class="text-2xl font-bold mb-2 text-white">é¡¹ç›®èµ„æ–™å·²æˆåŠŸæäº¤ï¼</h3>
                          <p class="text-slate-400">æ„Ÿè°¢æ‚¨çš„æäº¤ï¼æˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„å®Œæ•´é¡¹ç›®èµ„æ–™ï¼Œä¸“å±é¡¹ç›®é¡¾é—®å°†åœ¨24å°æ—¶å†…é€šè¿‡æ‚¨æä¾›çš„è”ç³»æ–¹å¼ä¸æ‚¨æ²Ÿé€šå¹¶æä¾›æŠ¥ä»·ã€‚</p>
                     </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- æç¤ºè¯åŠ©æ‰‹æ¨¡æ€æ¡† -->
    <div id="prompt-helper-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg p-8 shadow-2xl max-w-2xl w-full border border-slate-600 glass-card">
            <h3 class="text-xl font-bold mb-4 text-white">AIæç¤ºè¯åŠ©æ‰‹</h3>
            <p class="text-slate-400 mb-4">è¯·åœ¨ä¸‹æ–¹ç”¨ä»»ä½•è¯­è¨€æè¿°æ‚¨æƒ³è¦çš„äº§å“å¤–è§‚ï¼ŒAIä¼šä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„è‹±æ–‡æç¤ºè¯ã€‚</p>
            <textarea id="prompt-helper-input" class="w-full h-32 p-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 text-white" placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªç™½è‰²çš„ã€æç®€é£æ ¼çš„å’–å•¡æœºï¼Œå¸¦æœ‰æœ¨è´¨åº•åº§å’Œåœ†å½¢è§¦æ‘¸å±..."></textarea>
            <button id="prompt-helper-generate-btn" class="w-full mt-4 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-6 rounded-lg flex items-center justify-center">
                <span class="btn-text">è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯</span>
                <div class="loader hidden ml-2"></div>
            </button>
            <div id="prompt-helper-output-container" class="mt-4 hidden">
                <label class="block text-slate-300 font-semibold mb-2">ç”Ÿæˆçš„æç¤ºè¯:</label>
                <div id="prompt-helper-output" class="p-3 bg-slate-900 rounded-lg border border-slate-600 text-slate-300 min-h-[6rem]"></div>
            </div>
            <div class="flex gap-4 mt-6">
                <button id="prompt-helper-apply-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-6 rounded-lg disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>åº”ç”¨æç¤ºè¯</button>
                <button id="prompt-helper-close-btn" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-medium py-2 px-6 rounded-lg">å…³é—­</button>
            </div>
        </div>
    </div>


    <!-- é€šçŸ¥æ¨¡æ€æ¡† -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4"><div class="bg-slate-800 rounded-lg p-8 shadow-2xl max-w-md w-full border border-slate-600"><h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3><div id="modal-message" class="text-slate-300 mb-6 break-words"></div><button id="modal-close-button" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-6 rounded-lg">å…³é—­</button></div></div>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM & è§†å›¾ç®¡ç† ---
        const views = { 
            main: document.getElementById('main-view'), 
            chat: document.getElementById('chat-view'), 
            prd: document.getElementById('prd-view'), 
            experience: document.getElementById('experience-view') 
        };
        const experiencePages = { 4: document.getElementById('experience-prototype-page'), 5: document.getElementById('experience-quotation-page') };
        
        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const initialIdeaInput = document.getElementById('initial-idea-input'), startChatButton = document.getElementById('start-chat-button');
        const chatWindow = document.getElementById('chat-window'), chatInput = document.getElementById('chat-input'), sendChatButton = document.getElementById('send-chat-button'), aiThinkingIndicator = document.getElementById('ai-thinking-indicator'), finishChatButton = document.getElementById('finish-chat-button');
        const generatedPrdDiv = document.getElementById('generated-prd'), analyzeMarketButton = document.getElementById('analyze-market-button'), exportPdfButton = document.getElementById('export-pdf-button'), goToExperienceViewButton = document.getElementById('go-to-experience-view-button');
        const generateUserStoriesButton = document.getElementById('generate-user-stories-button'), generateBomButton = document.getElementById('generate-bom-button');
        const backToMainFromChat = document.getElementById('back-to-main-from-chat'), backToChat = document.getElementById('back-to-chat'), backToPrd = document.getElementById('back-to-prd');
        const appearanceKeywordTextarea = document.getElementById('appearance-keyword-textarea'), generateAppearanceButton = document.getElementById('generate-appearance-button'), sceneImageLoader = document.getElementById('scene-image-loader'), sceneProductImage = document.getElementById('scene-product-image');
        const personaTextarea = document.getElementById('persona-textarea'), applyPersonaButton = document.getElementById('apply-persona-button'), demoChatWindow = document.getElementById('demo-chat-window'), demoAiThinkingIndicator = document.getElementById('demo-ai-thinking-indicator'), demoChatInput = document.getElementById('demo-chat-input'), demoSendChatButton = document.getElementById('demo-send-chat-button'), emotionScreen = document.getElementById('emotion-screen'), emotionSelector = document.getElementById('emotion-selector');
        const goToQuotationButton = document.getElementById('go-to-quotation-button');
        const quotationForm = document.getElementById('quotation-form'), quotationSuccessMessage = document.getElementById('quotation-success-message');
        const userAdditionalRequirements = document.getElementById('user-additional-requirements');
        const modal = document.getElementById('notification-modal'), modalTitle = document.getElementById('modal-title'), modalMessage = document.getElementById('modal-message'), modalCloseButton = document.getElementById('modal-close-button');
        const startCreationLink = document.getElementById('start-creation-link');
        const openPromptHelperBtn = document.getElementById('open-prompt-helper');
        const promptHelperModal = document.getElementById('prompt-helper-modal');
        const promptHelperInput = document.getElementById('prompt-helper-input');
        const promptHelperGenerateBtn = document.getElementById('prompt-helper-generate-btn');
        const promptHelperOutputContainer = document.getElementById('prompt-helper-output-container');
        const promptHelperOutput = document.getElementById('prompt-helper-output');
        const promptHelperApplyBtn = document.getElementById('prompt-helper-apply-btn');
        const promptHelperCloseBtn = document.getElementById('prompt-helper-close-btn');

        // --- API é…ç½® ---
        const OPENAI_API_KEY = "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";
        const GOOGLE_API_KEY = "AIzaSyDJH7WRf67xuKh-qNCkoFqc3mCbREEZdns";
        const GOOGLE_GEMINI_STREAM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:streamGenerateContent?key=${GOOGLE_API_KEY}`;
        const GOOGLE_GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GOOGLE_API_KEY}`;
        const OPENAI_IMAGE_API_URL = 'https://api.openai.com/v1/images/generations';
        const OPENAI_TTS_API_URL = 'https://api.openai.com/v1/audio/speech';

        // --- çŠ¶æ€ç®¡ç† ---
        let chatHistory = [];
        let demoChatHistory = [];
        let finalProductPRD = "";
        let currentStep = 1;
        const defaultPRD = "è¿™æ˜¯ä¸€æ¬¾AIæ™ºèƒ½å’–å•¡æœºã€‚å…¶ç›®æ ‡ç”¨æˆ·æ˜¯è¿½æ±‚é«˜å“è´¨ç”Ÿæ´»çš„å¹´è½»ä¸“ä¸šäººå£«ã€‚æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬é€šè¿‡è¯­éŸ³å‘½ä»¤æˆ–ç§»åŠ¨åº”ç”¨ç¨‹åºå®šåˆ¶å’–å•¡çš„æµ“åº¦ã€æ¸©åº¦å’Œå¥¶æ³¡é‡ã€‚å®ƒè¿˜èƒ½å­¦ä¹ ç”¨æˆ·åå¥½å¹¶ä¸»åŠ¨æ¨èå’–å•¡ã€‚åœ¨è®¾è®¡ä¸Šï¼Œå®ƒæ‹¥æœ‰æ—¶å°šçš„é‡‘å±å¤–è§‚å’Œä¸€å—å°å·§çš„è§¦æ‘¸äº¤äº’å±ã€‚";
        let isMainImageGenerated = false;

        // --- æµç¨‹æ§åˆ¶ ---
        function showView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.toggle('active', key === viewName);
            });
            window.scrollTo(0,0);
        }

        function updateStepUI(step) {
            currentStep = step;
            for (let i = 1; i <= 5; i++) {
                const icon = document.getElementById(`step-icon-${i}`);
                if (icon) {
                    icon.classList.toggle('active', i <= currentStep);
                }
            }
        }
        
        function showStep(step) {
            updateStepUI(step);
            if (step === 1) showView('main');
            else if (step === 2) showView('chat');
            else if (step === 3) showView('prd');
            else if (step === 4 || step === 5) {
                showView('experience');
                Object.values(experiencePages).forEach(p => p.classList.add('hidden'));
                if(experiencePages[step]) experiencePages[step].classList.remove('hidden');
            }
        }

        document.querySelectorAll('.step-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const targetStep = parseInt(link.id.split('-')[2], 10);
                if (targetStep === 4) {
                    setupExperienceView(true); // isDemo = true
                    return;
                }
                if (targetStep <= currentStep) {
                    showStep(targetStep);
                } else {
                    showNotification("æµç¨‹æç¤º", "è¯·æŒ‰é¡ºåºå®Œæˆå½“å‰æ­¥éª¤åï¼Œæ‰èƒ½è®¿é—®åç»­æµç¨‹ã€‚");
                }
            });
        });

        // --- å·¥å…·å‡½æ•° ---
        function showNotification(title, message) { 
            modalTitle.textContent = title; 
            modalMessage.innerHTML = message; 
            modal.classList.remove('hidden'); 
        }
        function appendMessage(windowEl, sender, text) { 
            const container = document.createElement('div'); 
            const bubble = document.createElement('div'); 
            bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`; 
            bubble.innerHTML = marked.parse(text); 
            container.appendChild(bubble); 
            windowEl.appendChild(container); 
            bubble.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return bubble; 
        }
        function setChatUiLock(isLocked, chatInputEl, sendButtonEl, thinkingIndicatorEl) { 
            chatInputEl.disabled = isLocked; 
            sendButtonEl.disabled = isLocked; 
            thinkingIndicatorEl.classList.toggle('hidden', !isLocked); 
        }

        function formatGoogleHistory(history) {
            return history.map(item => ({
                role: item.role === 'assistant' ? 'model' : 'user',
                parts: [{ text: item.content }]
            })).filter(item => item.parts[0].text.trim() !== '');
        }

        async function playAudio(text) {
            try {
                const response = await fetch(OPENAI_TTS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'tts-1-hd',
                        input: text,
                        voice: 'nova'
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `OpenAI TTS API è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            } catch (error) {
                console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", error);
                showNotification('éŸ³é¢‘æ’­æ”¾å¤±è´¥', `æ— æ³•æ’­æ”¾AIè¯­éŸ³: ${error.message}`);
            }
        }

        async function callGoogleTextApi({history, elementToUpdate, isStream = false, withTTS = false}) {
            const apiUrl = isStream ? GOOGLE_GEMINI_STREAM_API_URL : GOOGLE_GEMINI_API_URL;
            let loadingBubble;
            const payload = { contents: formatGoogleHistory(history) };

            if (isStream && elementToUpdate) {
                if (elementToUpdate.id === 'chat-window' || elementToUpdate.id === 'demo-chat-window') {
                    loadingBubble = appendMessage(elementToUpdate, 'assistant', '');
                } else {
                    loadingBubble = elementToUpdate;
                    loadingBubble.innerHTML = '';
                }
            } else if (elementToUpdate) {
                 elementToUpdate.innerHTML = '<div class="flex items-center justify-center gap-3"><div class="loader"></div><p>AI æ­£åœ¨ç”Ÿæˆå†…å®¹...</p></div>';
            }
            
            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `Google API è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                let fullResponse = "";

                if (isStream) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        try {
                             const chunk = decoder.decode(value);
                             const lines = chunk.split('\n');
                             for(const line of lines) {
                                if (line.trim().startsWith('"text":')) {
                                    const textPart = JSON.parse(`{${line}}`).text;
                                    fullResponse += textPart;
                                }
                             }
                        } catch(e) { /* Ignore parsing errors from incomplete chunks */ }

                        if(loadingBubble) {
                            loadingBubble.innerHTML = marked.parse(fullResponse);
                            loadingBubble.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                    }
                     if(loadingBubble) {
                        loadingBubble.innerHTML = marked.parse(fullResponse);
                        loadingBubble.scrollIntoView({ behavior: 'smooth', block: 'end' });
                     }

                } else { // Non-streaming
                    const result = await response.json();
                    fullResponse = result.candidates[0]?.content?.parts[0]?.text || '';
                    if (elementToUpdate) {
                       elementToUpdate.innerHTML = marked.parse(fullResponse);
                    }
                }
                
                if (withTTS && fullResponse) {
                    await playAudio(fullResponse);
                }

                return fullResponse;

            } catch (error) {
                const errorMessage = `ä¸Google APIé€šä¿¡æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`;
                if (loadingBubble) { loadingBubble.innerHTML = `<p class="text-red-400">${errorMessage}</p>`; } 
                else if (elementToUpdate) { elementToUpdate.innerHTML = `<p class="text-red-400">${errorMessage}</p>`; }
                showNotification('API é€šä¿¡é”™è¯¯', errorMessage);
                return null;
            }
        }
        
        async function callOpenAIImageApi(prompt, loaderElement, imageElement) {
            loaderElement.classList.remove('hidden');
            if(imageElement) imageElement.style.opacity = '0.5';

            try {
                const response = await fetch(OPENAI_IMAGE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: prompt,
                        n: 1,
                        size: "1792x1024",
                        response_format: "b64_json"
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `DALL-E 3 API è¯·æ±‚å¤±è´¥`);
                }
                const result = await response.json();
                const b64_json = result.data[0].b64_json;
                if (b64_json) {
                    const imageUrl = `data:image/png;base64,${b64_json}`;
                    if(imageElement) {
                        imageElement.src = imageUrl;
                        isMainImageGenerated = true;
                    }
                    return imageUrl;
                } else {
                    throw new Error('æœªèƒ½ä»OpenAI APIè·å–æœ‰æ•ˆå›¾ç‰‡æ•°æ®ã€‚');
                }
            } catch (error) {
                showNotification('å›¾åƒç”Ÿæˆå¤±è´¥', `ä¸ DALL-E 3 é€šä¿¡æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
                if (imageElement) imageElement.src = `https://placehold.co/1792x1024/0f172a/9ca3af?text=ç”Ÿæˆå¤±è´¥`;
            } finally {
                loaderElement.classList.add('hidden');
                if(imageElement) imageElement.style.opacity = '1';
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function initializeChat() {
            const userInput = initialIdeaInput.value.trim();
            if (!userInput) { showNotification('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æ‚¨çš„åˆæ­¥æ„æƒ³ä»¥å¼€å§‹å¯¹è¯ã€‚'); return; }
            showStep(2);
            const systemPrompt = `ä½ æ˜¯ä¸€åèµ„æ·±çš„AIç¡¬ä»¶äº§å“ç»ç†ã€‚ä½ çš„ä»»åŠ¡æ˜¯é€šè¿‡å¤šè½®å¯¹è¯ï¼Œå¼•å¯¼ç”¨æˆ·æ˜ç¡®ä»–ä»¬çš„äº§å“æ„æƒ³ã€‚ä½ çš„å›å¤åº”è¯¥ç®€çŸ­ã€å‹å¥½ã€ä¸“ä¸šã€‚è¯·ä½¿ç”¨Markdownçš„ç²—ä½“æ ¼å¼ï¼ˆä¾‹å¦‚ **å…³é”®è¯**ï¼‰æ¥é«˜äº®ä½ è®¤ä¸ºé‡è¦çš„äº§å“ç‰¹æ€§ã€ç”¨æˆ·éœ€æ±‚æˆ–å…³é”®å†³ç­–ç‚¹ï¼Œè¿™äº›å†…å®¹å°†è¢«ç”¨é¢œè‰²å¼ºè°ƒå‡ºæ¥ã€‚`;
            chatHistory = [ { role: "system", content: systemPrompt } ];
            appendMessage(chatWindow, 'user', userInput);
            chatHistory.push({ role: "user", content: userInput });
            getAiResponse();
        }
        
        async function getAiResponse() {
            setChatUiLock(true, chatInput, sendChatButton, aiThinkingIndicator);
            const responseText = await callGoogleTextApi({
                history: chatHistory, 
                elementToUpdate: chatWindow, 
                isStream: true, 
                withTTS: false
            });
            if (responseText) {
                chatHistory.push({ role: "assistant", content: responseText });
            }
            setChatUiLock(false, chatInput, sendChatButton, aiThinkingIndicator); 
            chatInput.focus();
        }
        
        async function handleSendMessage() { 
            const userInput = chatInput.value.trim(); 
            if (!userInput) return; 
            appendMessage(chatWindow, 'user', userInput); 
            chatHistory.push({ role: "user", content: userInput }); 
            chatInput.value = ''; 
            await getAiResponse(); 
        }
        
        async function handleGeneratePRD() { 
            showStep(3);
            const finalPrompt = `æ ¹æ®æˆ‘ä»¬ä¹‹å‰å®Œæ•´çš„å¯¹è¯è®°å½•ï¼Œè¯·æ€»ç»“å¹¶ç”Ÿæˆä¸€ä»½ä¸“ä¸šã€è¯¦ç»†ã€ç»“æ„åŒ–çš„æœ€ç»ˆäº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆPRDï¼‰ã€‚å¦‚æœä¿¡æ¯ä¸è¶³ï¼Œè¯·æ ¹æ®äº§å“ç»ç†çš„ä¸“ä¸šçŸ¥è¯†ï¼Œå›´ç»•åˆå§‹æ„æƒ³è¿›è¡Œåˆç†çš„æ‰©å……å’Œè¡¥å®Œï¼Œç¡®ä¿æ–‡æ¡£çš„å®Œæ•´æ€§ã€‚è¯·åŒ…å«ï¼šäº§å“æ¦‚è¿°ã€ç›®æ ‡ç”¨æˆ·ç¾¤ä½“ã€äº§å“åŠŸèƒ½éœ€æ±‚ï¼ˆå«ä¼˜å…ˆçº§ï¼‰ã€éåŠŸèƒ½æ€§éœ€æ±‚ã€äº§å“å½¢æ€ä¸è®¾è®¡å»ºè®®ã€‚ä½¿ç”¨Markdownæ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–å¯¹è¯ã€‚`; 
            const messages = [...chatHistory, {role: 'user', content: finalPrompt}];
            finalProductPRD = await callGoogleTextApi({
                history: messages, 
                elementToUpdate: generatedPrdDiv, 
                isStream: true, 
                withTTS: false
            }) || "";
        }
        
        async function handleSectionGeneration(button, promptTemplate, sectionTitle) {
            button.disabled = true;
            button.innerHTML = '<div class="loader inline-block"></div> æ­£åœ¨ç”Ÿæˆ...';
            const prdContent = generatedPrdDiv.innerText;
            if (!prdContent) {
                showNotification("é”™è¯¯", "PRDå†…å®¹ä¸ºç©ºï¼Œè¯·å…ˆç”Ÿæˆä¸»æ–‡æ¡£ã€‚");
                button.disabled = false;
                button.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>ç”Ÿæˆå¤±è´¥`;
                return;
            }
            
            const prompt = promptTemplate.replace('${PRD_CONTENT}', prdContent);
            
            const sectionContainer = document.createElement('div');
            sectionContainer.innerHTML = `<hr class="my-8 border-dashed border-slate-600">`;
            const contentDiv = document.createElement('div');
            sectionContainer.appendChild(contentDiv);
            generatedPrdDiv.appendChild(sectionContainer);

            const newText = await callGoogleTextApi({
                history: [{role: 'user', content: prompt}], 
                elementToUpdate: contentDiv, 
                isStream: true, 
                withTTS: false
            });

            if (newText) {
                finalProductPRD += `\n\n---\n\n${newText}`;
                button.innerHTML = `<i class="fas fa-check mr-2"></i>å·²ç”Ÿæˆ ${sectionTitle}`;
            } else {
                button.innerHTML = `<i class="fas fa-times mr-2"></i>ç”Ÿæˆå¤±è´¥`;
            }
            button.disabled = false;
        }

        async function handleMarketAnalysis() { await handleSectionGeneration(analyzeMarketButton, `åŸºäºä»¥ä¸‹è¿™ä»½PRDï¼Œä¸ºæˆ‘ç”Ÿæˆä¸€ä»½ä¸“ä¸šçš„å¸‚åœºåˆ†ææŠ¥å‘Šï¼ŒåŒ…å«å¸‚åœºè§„æ¨¡é¢„ä¼°ã€ç›®æ ‡ç”¨æˆ·ç”»åƒã€ä¸»è¦ç«äº‰å¯¹æ‰‹åˆ†æå’ŒSWOTåˆ†æã€‚è¯·ç›´æ¥ä»¥Markdownçš„äºŒçº§æ ‡é¢˜ï¼ˆ## å¸‚åœºæ½œåŠ›åˆ†æï¼‰å¼€å§‹ï¼Œä¸è¦åŒ…å«ä»»ä½•å‰è¨€ã€‚PRDå…¨æ–‡å¦‚ä¸‹ï¼š\n\${PRD_CONTENT}`, "å¸‚åœºæ½œåŠ›åˆ†æ"); }
        async function handleGenerateUserStories() { await handleSectionGeneration(generateUserStoriesButton, `åŸºäºä»¥ä¸‹è¿™ä»½PRDï¼Œä¸ºæˆ‘ç”Ÿæˆè‡³å°‘5ä¸ªè¯¦ç»†çš„ç”¨æˆ·æ•…äº‹ï¼ˆUser Storiesï¼‰ï¼Œéµå¾ªâ€œä½œä¸ºä¸€ä¸ª<ç”¨æˆ·è§’è‰²>ï¼Œæˆ‘æƒ³è¦<å®ŒæˆæŸä¸ªåŠŸèƒ½>ï¼Œä»¥ä¾¿äº<å®ç°æŸç§ä»·å€¼>â€çš„æ ¼å¼ã€‚è¯·ç›´æ¥ä»¥Markdownçš„äºŒçº§æ ‡é¢˜ï¼ˆ## ç”¨æˆ·æ•…äº‹ï¼‰å¼€å§‹ï¼Œä¸è¦åŒ…å«ä»»ä½•å‰è¨€ã€‚PRDå…¨æ–‡å¦‚ä¸‹ï¼š\n\${PRD_CONTENT}`, "ç”¨æˆ·æ•…äº‹"); }
        async function handleGenerateBOM() { await handleSectionGeneration(generateBomButton, `åŸºäºä»¥ä¸‹è¿™ä»½PRDï¼Œä¸ºæˆ‘ç”Ÿæˆä¸€ä»½é¢„ä¼°çš„ç‰©æ–™æ¸…å•ï¼ˆBOMï¼‰ï¼Œåˆ—å‡ºå…³é”®ç¡¬ä»¶ç»„ä»¶ï¼ˆå¦‚ä¸»æ§èŠ¯ç‰‡ã€ä¼ æ„Ÿå™¨ã€æ˜¾ç¤ºå±ã€ç”µæ± ç­‰ï¼‰çš„å¯èƒ½å‹å·å’Œé¢„ä¼°æ•°é‡ã€‚è¯·ç›´æ¥ä»¥Markdownçš„äºŒçº§æ ‡é¢˜ï¼ˆ## ç‰©æ–™æ¸…å• (BOM)ï¼‰å¼€å§‹ï¼Œä¸è¦åŒ…å«ä»»ä½•å‰è¨€ã€‚PRDå…¨æ–‡å¦‚ä¸‹ï¼š\n\${PRD_CONTENT}`, "ç‰©æ–™æ¸…å• (BOM)"); }
        
        async function setupExperienceView(isDemo = false) { 
            let prdToUse = finalProductPRD;
            if (isDemo && !finalProductPRD) {
                prdToUse = defaultPRD;
            } else if (!finalProductPRD) {
                 showNotification("é”™è¯¯", "è¯·å…ˆç”ŸæˆPRDæ–‡æ¡£ã€‚"); 
                 return;
            }
            
            showStep(4);
            personaTextarea.value = "æ­£åœ¨æå–AIè§’è‰²æç¤ºè¯..."; 
            appearanceKeywordTextarea.value = "æ­£åœ¨æå–äº§å“å¤–è§‚å…³é”®è¯...";
            
            const personaPrompt = `ä»ä»¥ä¸‹PRDä¸­ï¼Œä¸ºäº§å“çš„AIåŠ©æ‰‹åˆ›å»ºä¸€ä¸ªè§’è‰²å®šä¹‰å’Œç³»ç»Ÿæç¤ºè¯ã€‚è¿™ä¸ªå®šä¹‰éœ€è¦æ¸…æ™°ã€ç®€æ´ï¼ŒåŒ…å«å®ƒçš„æ€§æ ¼ã€è¯´è¯é£æ ¼å’Œä¸»è¦ä»»åŠ¡ã€‚è¯·ç›´æ¥è¾“å‡ºè§’è‰²å®šä¹‰çš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–å¯¹è¯ã€‚PRDå†…å®¹ï¼š\n\n${prdToUse}`; 
            callGoogleTextApi({history: [{role:'user', content: personaPrompt}]}).then(text => { if(text) personaTextarea.value = text; });
            
            const scenePrompt = `æ ¹æ®ä»¥ä¸‹äº§å“éœ€æ±‚æ–‡æ¡£(PRD)ï¼Œæå–ä¸€ç³»åˆ—ç”¨äºAIå›¾åƒç”Ÿæˆçš„ã€æè¿°äº§å“å¤–è§‚çš„å…³é”®è¯ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰ã€‚è¯·ä»…ç”¨é€—å·åˆ†éš”è¿™äº›å…³é”®è¯ã€‚ä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ã€‚PRDï¼š\n\n${prdToUse}`; 
            callGoogleTextApi({history: [{role:'user', content: scenePrompt}]}).then(text => { if(text) appearanceKeywordTextarea.value = text; }); 
        }
        
        async function generateProductImage() {
            const productKeywords = appearanceKeywordTextarea.value.trim();
            if (!productKeywords) { showNotification("é”™è¯¯", "äº§å“å¤–è§‚å…³é”®è¯ä¸èƒ½ä¸ºç©ºã€‚"); return; }
            const finalPrompt = `${productKeywords}, product photography, studio shot, on a clean white background, minimalist, no logo, no branding, no props, professional studio lighting, soft shadows, photorealistic`;
            await callOpenAIImageApi(finalPrompt, sceneImageLoader, sceneProductImage);
        }

        async function applyAndStartPersona() { 
            const personaPrompt = personaTextarea.value.trim();
            if (!personaPrompt) {showNotification("é”™è¯¯", "AIè§’è‰²æç¤ºè¯ä¸èƒ½ä¸ºç©ºã€‚"); return;} 
            demoChatHistory = [{ role: "system", content: personaPrompt }]; 
            demoChatWindow.innerHTML = ''; 
            
            let prdToUse = finalProductPRD || defaultPRD;
            const openingLinePrompt = `Based on the following PRD, create a natural, engaging opening line for a user to start a conversation with the product's AI assistant. The line should be from the user's perspective. Output only the opening line text. PRD:\n\n${prdToUse}`;
            const openingLine = await callGoogleTextApi({history: [{ role: 'user', content: openingLinePrompt }]});

            if (openingLine) {
                appendMessage(demoChatWindow, 'user', openingLine); 
                demoChatHistory.push({ role: "user", content: openingLine });
                await getDemoAiResponse();
            } else {
                showNotification("é”™è¯¯", "æ— æ³•ç”Ÿæˆå¼€åœºç™½ã€‚");
            }
        }

        async function analyzeEmotion(text) {
            const prompt = `åˆ†æä»¥ä¸‹æ–‡æœ¬çš„æƒ…ç»ªã€‚è¯·åªç”¨ä¸€ä¸ªæœ€èƒ½ä»£è¡¨è¯¥æƒ…ç»ªçš„è¡¨æƒ…ç¬¦å·æ¥å›åº”ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ–‡æœ¬æ˜¯å¼€å¿ƒçš„ï¼Œå°±å›åº”â€œğŸ˜Šâ€ã€‚å¦‚æœæ˜¯æ‚²ä¼¤çš„ï¼Œå°±å›åº”â€œğŸ˜¢â€ã€‚å¦‚æœæ˜¯æä¾›å¸®åŠ©æˆ–ä¿¡æ¯çš„ï¼Œå°±å›åº”â€œğŸ’¡â€ã€‚å¦‚æœæ˜¯æƒŠè®¶çš„ï¼Œç”¨â€œğŸ˜®â€ã€‚å¦‚æœæ˜¯ç®€å•çš„ç¡®è®¤ï¼Œç”¨â€œğŸ™‚â€ã€‚ä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ–è§£é‡Šã€‚æ–‡æœ¬æ˜¯ï¼šâ€œ${text}â€`;
            const emoji = await callGoogleTextApi({history: [{ role: 'user', content: prompt }]});
            emotionScreen.textContent = emoji || 'ğŸ™‚';
        }
        
        async function getDemoAiResponse() {
            setChatUiLock(true, demoChatInput, demoSendChatButton, demoAiThinkingIndicator);
            const responseText = await callGoogleTextApi({
                history: demoChatHistory, 
                elementToUpdate: demoChatWindow, 
                isStream: true, 
                withTTS: true
            });
            if(responseText) { 
                demoChatHistory.push({ role: "assistant", content: responseText });
                analyzeEmotion(responseText);
            }
            setChatUiLock(false, demoChatInput, demoSendChatButton, demoAiThinkingIndicator);
        }

        async function handleDemoChatSend() { 
            const userInput = demoChatInput.value.trim(); if (!userInput) return; 
            appendMessage(demoChatWindow, 'user', userInput); 
            demoChatHistory.push({ role: "user", content: userInput });
            demoChatInput.value = '';
            await getDemoAiResponse();
        }
        
        // --- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨ ---
        showStep(1); 
        startChatButton.onclick = initializeChat; 
        sendChatButton.onclick = handleSendMessage; 
        chatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } };
        finishChatButton.onclick = handleGeneratePRD; 
        analyzeMarketButton.onclick = handleMarketAnalysis; 
        generateUserStoriesButton.onclick = handleGenerateUserStories;
        generateBomButton.onclick = handleGenerateBOM;
        exportPdfButton.onclick = () => {
             showNotification("åŠŸèƒ½å¾…å¼€å‘", "å¯¼å‡ºPDFåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚");
             console.log("Export PDF clicked");
        };
        goToExperienceViewButton.onclick = () => setupExperienceView(false); 
        backToMainFromChat.onclick = () => showStep(1);
        backToChat.onclick = () => showStep(2);
        backToPrd.onclick = () => showStep(3);
        
        generateAppearanceButton.onclick = generateProductImage;
        
        applyPersonaButton.onclick = applyAndStartPersona;
        demoSendChatButton.onclick = handleDemoChatSend; 
        demoChatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleDemoChatSend(); } };
        goToQuotationButton.onclick = () => showStep(5);
        
        openPromptHelperBtn.addEventListener('click', () => {
            promptHelperModal.classList.remove('hidden');
        });

        promptHelperCloseBtn.addEventListener('click', () => {
            promptHelperModal.classList.add('hidden');
        });
        
        promptHelperGenerateBtn.addEventListener('click', async () => {
            const userInput = promptHelperInput.value.trim();
            if (!userInput) {
                showNotification("è¾“å…¥ä¸ºç©º", "è¯·è¾“å…¥æ‚¨çš„äº§å“å¤–è§‚æè¿°ã€‚");
                return;
            }

            const loader = promptHelperGenerateBtn.querySelector('.loader');
            const btnText = promptHelperGenerateBtn.querySelector('.btn-text');
            loader.classList.remove('hidden');
            btnText.textContent = "ç”Ÿæˆä¸­...";
            promptHelperGenerateBtn.disabled = true;

            const systemPrompt = `From the user's description, extract a concise, comma-separated list of the most essential English keywords for an AI image generator like DALL-E 3. Focus on core visual attributes. Be brief. User's description: "${userInput}"`;
            
            const generatedPrompt = await callGoogleTextApi({ history: [{ role: 'user', content: systemPrompt }] });
            
            if (generatedPrompt) {
                promptHelperOutput.textContent = generatedPrompt;
                promptHelperOutputContainer.classList.remove('hidden');
                promptHelperApplyBtn.disabled = false;
            } else {
                showNotification("ç”Ÿæˆå¤±è´¥", "æ— æ³•ä»æ‚¨çš„æè¿°ç”Ÿæˆæç¤ºè¯ã€‚");
            }
            
            loader.classList.add('hidden');
            btnText.textContent = "è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯";
            promptHelperGenerateBtn.disabled = false;
        });

        promptHelperApplyBtn.addEventListener('click', () => {
            const currentKeywords = appearanceKeywordTextarea.value.trim();
            const newKeywords = promptHelperOutput.textContent.trim();
            if (currentKeywords && newKeywords) {
                appearanceKeywordTextarea.value = currentKeywords + ', ' + newKeywords;
            } else if (newKeywords) {
                appearanceKeywordTextarea.value = newKeywords;
            }
            promptHelperModal.classList.add('hidden');
        });

        quotationForm.addEventListener('submit', (e) => {
             e.preventDefault(); 
             
             // æ•´åˆæ‰€æœ‰é¡¹ç›®ä¿¡æ¯
             const finalDocument = `
# æœ€ç»ˆé¡¹ç›®éœ€æ±‚æ–‡æ¡£

## 1. ç”¨æˆ·è”ç³»æ–¹å¼
- **é‚®ç®±:** ${document.getElementById('user-email').value}
- **å…¶ä»–è”ç³»æ–¹å¼:** ${document.getElementById('user-contact').value}

---

## 2. äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)
${generatedPrdDiv.innerText}

---

## 3. AI è§’è‰²è®¾å®š
\`\`\`
${personaTextarea.value}
\`\`\`

---

## 4. äº§å“å¤–è§‚ç”Ÿæˆå…³é”®è¯
\`\`\`
${appearanceKeywordTextarea.value}
\`\`\`

---

## 5. ç”¨æˆ·è¡¥å……è¯´æ˜
${userAdditionalRequirements.value}

---

## 6. äº§å“æ•ˆæœå›¾
**å›¾ç‰‡Base64æº:**
(ä¸ºä¿è¯æ–‡æ¡£ç®€æ´ï¼Œæ­¤å¤„ä»…å¼•ç”¨ï¼Œå®é™…æäº¤æ—¶å¯åŒ…å«å®Œæ•´Base64æ•°æ®)
${sceneProductImage.src.substring(0, 100)}...
             `;

            const submissionPackage = {
                contactInfo: { 
                    email: document.getElementById('user-email').value, 
                    other: document.getElementById('user-contact').value 
                },
                fullDocument: finalDocument,
                submissionTimestamp: new Date().toISOString()
            };
            
            // æ­¤å¤„åº”ä¸ºå‘é€åˆ°åç«¯çš„é€»è¾‘
            console.log("é¡¹ç›®æŠ¥ä»·èµ„æ–™å·²æ‰“åŒ… (æ¨¡æ‹Ÿå‘é€):", submissionPackage);

            document.getElementById('quotation-form-container').classList.add('hidden');
            quotationSuccessMessage.classList.remove('hidden'); 
        });
        modalCloseButton.onclick = () => modal.classList.add('hidden');
        startCreationLink.onclick = (e) => { e.preventDefault(); document.querySelector('#creation-process').scrollIntoView({ behavior: 'smooth' }); };

        // åˆå§‹åŒ–æƒ…ç»ªé€‰æ‹©å™¨
        const emotions = ['ğŸ™‚', 'ğŸ˜Š', 'ğŸ’¡', 'ğŸ¤”', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ‘', 'ğŸ˜'];
        emotionSelector.innerHTML = '';
        emotions.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emotion-choice';
            span.textContent = emoji;
            span.onclick = () => { emotionScreen.textContent = emoji; };
            emotionSelector.appendChild(span);
        });
    });
    </script>
</body>
</html>
