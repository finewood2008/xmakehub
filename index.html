<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMAKEHUB AI Creation Lab - From Prompt to Product</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --tech-blue: #0ea5e9; /* sky-500 */
            --vibrant-orange: #f97316; /* orange-500 */
            --dark-bg: #0c112b; /* A dark navy blue */
            --card-bg: rgba(22, 29, 63, 0.5); 
            --border-color: rgba(56, 189, 248, 0.2);
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #d1d5db; /* gray-300 */
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 25px 25px;
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .gradient-text {
            background: linear-gradient(90deg, var(--tech-blue) 0%, var(--vibrant-orange) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .loader, .prompt-loader {
            border: 4px solid #374151; /* gray-700 */
            border-top: 4px solid var(--tech-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .prompt-loader { width: 16px; height: 16px; border-width: 2px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }

        .chat-container-main {
            height: calc(100vh - 76px);
        }

        .chat-bubble { max-width: 90%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }
        .user-bubble { background-color: var(--tech-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-bubble { background-color: #374151; /* gray-700 */ color: #d1d5db; align-self: flex-start; border-bottom-left-radius: 4px; }
        .ai-bubble strong { color: var(--tech-blue); }
        
        .prose { color: #d1d5db; }
        .prose h1, .prose h2 { color: white; border-bottom: 1px solid #4b5563; padding-bottom: 0.5em; margin-bottom: 1em; }
        .prose h3, .prose h4, .prose h5, .prose h6 { color: #93c5fd; margin-top: 2em; margin-bottom: 1em; }
        .prose strong { color: var(--tech-blue); }
        .prose ul > li::before { background-color: var(--tech-blue); }
        .prose p, .prose ul, .prose ol { line-height: 1.7; }
        .prose hr { border-color: #4b5563; }

        .step-icon {
            display: flex; align-items: center; justify-content: center;
            width: 4rem; height: 4rem; margin-bottom: 1rem;
            background-color: rgba(255, 255, 255, 0.05); color: #6b7280;
            border-radius: 50%; border: 2px solid #374151;
            font-size: 1.5rem; transition: all 0.3s ease-in-out; position: relative;
        }
        @media (min-width: 768px) {
            .step-icon { width: 5rem; height: 5rem; font-size: 1.875rem; }
        }
        .step-icon.active {
            background-color: var(--tech-blue); color: white; border-color: var(--tech-blue);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); }
            50% { box-shadow: 0 0 35px 10px rgba(249, 115, 22, 0.7); }
        }
        .step-icon.emphasized {
            background-color: var(--vibrant-orange); color: white; border-color: var(--vibrant-orange);
            animation: pulse 2s infinite;
        }
        .step-link { cursor: pointer; }
        
        .emotion-choice {
            cursor: pointer; font-size: 1.5rem; transition: all 0.2s ease-in-out;
            padding: 4px; border-radius: 8px;
        }
        @media (min-width: 768px) {
            .emotion-choice { font-size: 1.75rem; }
        }
        .emotion-choice:hover {
            transform: scale(1.25); background-color: rgba(255, 255, 255, 0.1);
        }
        .prompt-generator-icon {
            cursor: pointer; color: #f97316; margin-left: 0.5rem; transition: transform 0.2s;
        }
        .prompt-generator-icon:hover { transform: scale(1.2); }
        
    </style>
</head>
<body class="min-h-screen">
    
    <!-- Main View -->
    <div id="main-view" class="view active">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="text-xl font-bold text-white"><i class="fas fa-atom mr-2 gradient-text"></i>XMAKEHUB <span class="gradient-text hidden sm:inline">AI Creation Lab</span></div>
            </div>
        </nav>
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Hero Section -->
            <section class="text-center py-12 md:py-16 rounded-2xl">
                <h1 class="text-4xl sm:text-5xl lg:text-7xl font-black mb-4 text-white">AI Creation Lab</h1>
                <p class="text-base sm:text-lg lg:text-xl text-slate-300 max-w-3xl mx-auto mb-6 font-semibold">Build an AI Hardware Device with a Single Sentence, <span class="gradient-text">From Prompt to Product</span></p>
                <p class="text-sm sm:text-base text-slate-400 max-w-2xl mx-auto mb-8">Here, any hardware idea you have can be transformed from a vague notion into detailed specifications, realistic prototypes, and finally, a business evaluation through deep collaboration with our advanced AI Product Manager.</p>
                <div>
                    <a href="#creation-process" id="start-creation-link" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 sm:px-8 rounded-full text-base sm:text-lg shadow-lg shadow-sky-500/30 transform hover:scale-105 transition-transform">Start Now <i class="fas fa-rocket ml-2"></i></a>
                </div>
            </section>

            <!-- How It Works Section -->
            <section id="how-it-works" class="py-12">
                <h2 class="text-3xl font-bold text-center mb-12 text-white">How It Works</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-8 text-center relative">
                    <!-- Dashed line connector for desktop -->
                    <div class="hidden lg:block absolute top-1/2 left-0 w-full h-px" style="transform: translateY(-5rem);">
                         <svg width="100%" height="2" class="absolute top-1/2 left-0" style="transform: translateY(-50%);">
                            <line x1="10%" y1="1" x2="90%" y2="1" stroke-width="2" stroke-dasharray="8 8" class="stroke-slate-600"/>
                        </svg>
                    </div>
                    <a id="step-link-1" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-1" class="step-icon"><i class="fas fa-lightbulb"></i></div>
                        <h3 class="font-semibold text-base md:text-lg text-white mb-2">1. Propose Idea</h3>
                        <p class="text-slate-400 text-sm">Describe your product idea in one sentence.</p>
                    </a>
                    <a id="step-link-2" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-2" class="step-icon"><i class="fas fa-comments"></i></div>
                        <h3 class="font-semibold text-base md:text-lg text-white mb-2">2. AI Dialogue</h3>
                        <p class="text-slate-400 text-sm">Chat with the AI PM to clarify details.</p>
                    </a>
                    <a id="step-link-3" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-3" class="step-icon"><i class="fas fa-file-alt"></i></div>
                        <h3 class="font-semibold text-base md:text-lg text-white mb-2">3. Generate PRD</h3>
                        <p class="text-slate-400 text-sm">Get a professional PRD with one click.</p>
                    </a>
                    <a id="step-link-4" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-4" class="step-icon emphasized"><i class="fas fa-vr-cardboard"></i></div>
                        <h3 class="font-semibold text-base md:text-lg text-white mb-2">4. Immersive Experience</h3>
                        <p class="text-slate-400 text-sm">Experience prototypes and renderings.</p>
                    </a>
                    <a id="step-link-5" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-5" class="step-icon"><i class="fas fa-tags"></i></div>
                        <h3 class="font-semibold text-base md:text-lg text-white mb-2">5. Get a Quote</h3>
                        <p class="text-slate-400 text-sm">Receive a production quote and start.</p>
                    </a>
                </div>
            </section>
            
            <section id="creation-process" class="glass-card p-6 md:p-8 mt-8">
                 <h2 class="text-2xl md:text-3xl font-bold mb-6 text-white">Submit Your Initial Idea</h2>
                 <textarea id="initial-idea-input" class="w-full h-32 p-4 border bg-slate-800 border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="Briefly describe your product concept, e.g., 'I want to develop a smart coffee machine with AI features...'"></textarea>
                 <div class="mt-4 flex justify-center">
                     <button id="start-chat-button" class="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-medium py-3 px-8 rounded-lg transition-colors flex items-center justify-center">Start Dialogue with AI Product Manager <i class="fas fa-comments ml-2"></i></button>
                 </div>
            </section>
        </main>
        <footer class="bg-slate-900/50 text-white py-12 mt-16">
            <div class="container mx-auto px-4 text-center text-slate-400">
                <p>Â© 2025 XMAKEHUB AI Creation Lab. All Rights Reserved.</p>
                <div class="mt-2 inline-block">
                    <a href="#" id="admin-login-link" class="inline-block p-2 text-xs text-slate-500 hover:text-sky-400">Admin Login</a>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Chat View -->
    <div id="chat-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-lg sm:text-xl font-bold text-white"><i class="fas fa-comments mr-2 gradient-text"></i>Dialogue with AI Product Manager</div><button id="back-to-main-from-chat" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-4 sm:px-5 rounded-lg text-sm sm:text-base"><i class="fas fa-arrow-left mr-2"></i>Back</button></div></nav>
        <main class="container mx-auto p-2 sm:p-4 flex flex-col chat-container-main">
             <div class="border border-slate-700 rounded-lg p-3 sm:p-4 flex flex-col glass-card flex-grow overflow-hidden">
                <div id="chat-window" class="flex flex-col gap-4 mb-4 pr-2 flex-grow overflow-y-auto"></div>
                <div id="ai-thinking-indicator" class="hidden flex items-center gap-3 self-start my-2"><div class="ai-bubble loader !p-3"></div><p class="text-slate-400 text-sm">Typing...</p></div>
                <div class="pt-4 border-t border-slate-700 mt-2">
                     <div class="flex items-center gap-2 sm:gap-3">
                        <input id="chat-input" type="text" class="flex-grow w-full p-3 border bg-slate-800 border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="Type here...">
                        <button id="send-chat-button" class="bg-orange-500 hover:bg-orange-600 text-white font-medium p-3 rounded-lg transition-colors flex items-center justify-center"><span class="hidden sm:inline">Send</span> <i class="fas fa-paper-plane sm:ml-2"></i></button>
                    </div>
                </div>
            </div>
            <div class="mt-4 sm:mt-6 text-center flex-shrink-0"><button id="finish-chat-button" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg transition-colors">Requirements Clear, Generate PRD <i class="fas fa-file-alt ml-2"></i></button></div>
        </main>
    </div>

    <!-- PRD View -->
    <div id="prd-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-base sm:text-xl font-bold text-white truncate"><i class="fas fa-file-alt mr-2 gradient-text"></i>Product Requirement Document (PRD)</div><button id="back-to-chat" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-4 sm:px-5 rounded-lg text-sm sm:text-base flex-shrink-0"><i class="fas fa-arrow-left mr-2"></i>Back</button></div></nav>
        <main class="container mx-auto p-2 sm:p-4">
             <div class="glass-card p-4 sm:p-6 md:p-8">
                 <div id="generated-prd" contenteditable="true" class="p-4 sm:p-6 bg-slate-900 rounded-lg border border-slate-700 prose max-w-none focus:ring-2 focus:ring-sky-500 min-h-[50vh]"></div>
                 <div id="prd-actions" class="flex flex-wrap gap-2 sm:gap-4 mt-6">
                     <button id="generate-user-stories-button" class="flex-grow sm:flex-grow-0 bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-4 rounded-lg text-sm"><i class="fas fa-users mr-2"></i>User Stories</button>
                     <button id="generate-bom-button" class="flex-grow sm:flex-grow-0 bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg text-sm"><i class="fas fa-microchip mr-2"></i>Bill of Materials</button>
                     <button id="analyze-market-button" class="flex-grow sm:flex-grow-0 bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg text-sm"><i class="fas fa-chart-line mr-2"></i>Market Analysis</button>
                     <button id="export-pdf-button" class="flex-grow sm:flex-grow-0 bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-4 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                 </div>
                 <h2 class="text-xl sm:text-2xl font-bold mt-12 mb-6 text-white">Next Step: Immersive Experience</h2>
                 <p class="text-slate-400 mb-4 text-sm sm:text-base">Enter a new immersive experience center to turn your ideas into reality and get a quote.</p>
                 <button id="go-to-experience-view-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-8 rounded-lg transition-colors text-base sm:text-lg">Enter Experience & Quoting Center <i class="fas fa-vr-cardboard ml-2"></i></button>
            </div>
        </main>
    </div>

    <!-- Experience & Prototype View -->
    <div id="experience-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-base sm:text-xl font-bold text-white truncate"><i class="fas fa-atom mr-2 gradient-text"></i>Prototype Experience & Quoting Center</div><button id="back-to-prd" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-4 sm:px-5 rounded-lg text-sm sm:text-base flex-shrink-0"><i class="fas fa-arrow-left mr-2"></i>Back</button></div></nav>
        <main class="container mx-auto px-2 sm:px-4 py-8">
            <div id="experience-prototype-page">
                <h2 class="text-2xl sm:text-3xl font-bold mb-8 text-center text-white">4. Immersive Experience</h2>
                
                <section class="glass-card p-4 sm:p-6 md:p-8">
                    <!-- Top: Large Image Frame -->
                    <div id="immersive-image-container" class="w-full max-w-4xl mx-auto bg-slate-900 rounded-lg p-2 sm:p-4 relative aspect-[16/9] flex items-center justify-center border border-slate-700 mb-8">
                        <div id="scene-image-loader" class="hidden absolute inset-0 bg-slate-900/80 flex flex-col items-center justify-center rounded-lg">
                            <div class="loader"></div>
                            <p class="mt-4 text-slate-400">AI is generating the image...</p>
                        </div>
                        <img id="scene-product-image" src="https://placehold.co/1792x1024/0f172a/9ca3af?text=Product+Rendering" alt="Product Rendering" class="max-w-full max-h-full object-contain rounded" onerror="this.onerror=null;this.src='https://placehold.co/1792x1024/e2e8f0/334155?text=Image+failed+to+load';">
                    </div>

                    <!-- Middle: Dialogue Simulator and Emotion Screen -->
                    <div class="flex flex-col lg:flex-row gap-8 mb-8">
                        <div class="flex-grow">
                            <h4 class="font-semibold text-lg mb-4 text-white">Product AI Dialogue Simulator</h4>
                            <div class="border border-slate-700 rounded-lg p-4 flex flex-col bg-slate-900/50 h-[400px] lg:h-full">
                                <div id="demo-chat-window" class="flex flex-col gap-4 mb-4 pr-2 flex-grow overflow-y-auto"></div>
                                <div id="demo-ai-thinking-indicator" class="hidden flex items-center gap-3 self-start mt-2"><div class="ai-bubble loader !p-3"></div><p class="text-slate-400 text-sm">Typing...</p></div>
                                <div class="flex items-center gap-3 pt-4 border-t border-slate-700 mt-4 flex-shrink-0">
                                    <input id="demo-chat-input" type="text" class="flex-grow w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white" placeholder="Talk to your AI assistant...">
                                    <button id="demo-send-chat-button" class="bg-sky-500 hover:bg-sky-600 text-white font-medium p-3 rounded-lg flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="w-full lg:w-1/5 flex flex-col items-center flex-shrink-0">
                            <h4 class="font-semibold text-lg mb-4 text-white">AI Emotion</h4>
                             <div id="emotion-screen" class="w-40 h-40 sm:w-48 sm:h-48 bg-slate-900 rounded-2xl flex items-center justify-center text-6xl sm:text-7xl shadow-inner border border-slate-700 mb-4 mx-auto">
                                 ðŸ™‚
                             </div>
                             <div id="emotion-selector" class="flex flex-wrap gap-3 justify-center">
                                <!-- Emojis will be dynamically populated by JS -->
                             </div>
                        </div>
                    </div>
                    
                    <!-- Bottom: Prompt Controls -->
                     <hr class="my-8 border-slate-700"/>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <div>
                            <label for="persona-textarea" class="block text-slate-300 font-semibold mb-2">AI Persona</label>
                            <textarea id="persona-textarea" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 text-white"></textarea>
                            <button id="apply-persona-button" class="w-full mt-2 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-6 rounded-lg">Apply Persona & Start Dialogue</button>
                         </div>
                         <div>
                             <div class="flex items-center mb-2">
                                <label for="appearance-keyword-textarea" class="block text-slate-300 font-semibold">Product Appearance Settings</label>
                                <span id="open-prompt-helper" class="prompt-generator-icon ml-2" title="AI Prompt Helper"><i class="fas fa-lightbulb"></i></span>
                             </div>
                             <textarea id="appearance-keyword-textarea" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white"></textarea>
                             <button id="generate-appearance-button" class="w-full mt-2 bg-sky-500 hover:bg-sky-600 text-white font-medium py-3 px-6 rounded-lg">Generate Product Rendering</button>
                         </div>
                     </div>
                </section>
                
                <div class="text-center mt-12"><button id="go-to-quotation-button" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg text-lg">Next: Prototyping & Quoting <i class="fas fa-arrow-right ml-2"></i></button></div>
            </div>
            <div id="experience-quotation-page" class="hidden">
                 <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-white">5. Get a Professional Quote</h2>
                 <div class="glass-card p-4 sm:p-6 md:p-8">
                     <div id="quotation-form-container">
                         <h3 class="text-xl sm:text-2xl font-bold mb-4 text-white">Final Confirmation & Submission</h3>
                         <p class="text-slate-400 mb-6 text-sm sm:text-base">Please add your final requirements below. After submission, we will package all project materials (PRD, renderings, AI persona, and additional notes), and our project consultant will contact you shortly with a quote.</p>
                         <form id="quotation-form">
                            <div class="mb-6">
                                <label for="user-additional-requirements" class="block text-slate-300 font-semibold mb-2">Additional Requirements</label>
                                <textarea id="user-additional-requirements" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="You can enter any additional requirements, specifications, or special instructions here..."></textarea>
                            </div>
                             <div class="mb-4">
                                <label for="user-email" class="block text-slate-300 font-semibold mb-2">Email Address</label>
                                <input type="email" id="user-email" class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="example@email.com" required>
                            </div>
                             <div class="mb-6">
                                <label for="user-contact" class="block text-slate-300 font-semibold mb-2">Other Contact Info (Phone, etc.)</label>
                                <input type="text" id="user-contact" class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="Your phone number or other ID">
                            </div>
                             <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg text-lg">Submit Project for Quote</button>
                         </form>
                     </div>
                     <div id="quotation-success-message" class="hidden text-center py-10">
                          <div class="text-6xl text-green-500 mb-4"><i class="fas fa-check-circle"></i></div>
                          <h3 class="text-xl sm:text-2xl font-bold mb-2 text-white">Project materials submitted successfully!</h3>
                          <p class="text-slate-400">Thank you for your submission! We have received your complete project materials. A dedicated project consultant will contact you within 24 hours via the provided contact information to discuss and provide a quote.</p>
                     </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4">
        <!-- Prompt Helper Modal -->
        <div id="prompt-helper-modal" class="modal-content hidden bg-slate-800 rounded-lg p-6 sm:p-8 shadow-2xl max-w-2xl w-full border border-slate-600 glass-card">
            <h3 class="text-xl font-bold mb-4 text-white">AI Prompt Helper</h3>
            <p class="text-slate-400 mb-4">Describe the product appearance you want below in any language, and the AI will generate a professional English prompt for you.</p>
            <textarea id="prompt-helper-input" class="w-full h-32 p-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 text-white" placeholder="e.g., A white, minimalist coffee machine with a wooden base and a round touchscreen..."></textarea>
            <button id="prompt-helper-generate-btn" class="w-full mt-4 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-6 rounded-lg flex items-center justify-center">
                <span class="btn-text">Auto-generate Prompt</span>
                <div class="loader hidden ml-2"></div>
            </button>
            <div id="prompt-helper-output-container" class="mt-4 hidden">
                <label class="block text-slate-300 font-semibold mb-2">Generated Prompt:</label>
                <div id="prompt-helper-output" class="p-3 bg-slate-900 rounded-lg border border-slate-600 text-slate-300 min-h-[6rem]"></div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mt-6">
                <button id="prompt-helper-apply-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-6 rounded-lg disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>Apply Prompt</button>
                <button data-close-modal class="w-full bg-slate-600 hover:bg-slate-500 text-white font-medium py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
        <!-- Notification Modal -->
        <div id="notification-modal" class="modal-content hidden bg-slate-800 rounded-lg p-8 shadow-2xl max-w-md w-full border border-slate-600"><h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3><div id="modal-message" class="text-slate-300 mb-6 break-words"></div><button data-close-modal class="w-full bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-6 rounded-lg">Close</button></div>
        <!-- Admin Login Modal -->
        <div id="admin-login-modal" class="modal-content hidden bg-slate-800 rounded-lg p-8 shadow-2xl max-w-sm w-full border border-slate-600 glass-card">
            <h3 class="text-xl font-bold mb-4 text-white text-center">Admin Login</h3>
            <form id="admin-login-form">
                <div class="mb-4"><label for="admin-username" class="block text-slate-300 font-semibold mb-2">Username</label><input type="text" id="admin-username" class="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" required></div>
                <div class="mb-6"><label for="admin-password" class="block text-slate-300 font-semibold mb-2">Password</label><input type="password" id="admin-password" class="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" required></div>
                <p id="login-error-msg" class="text-red-400 text-sm mb-4 hidden"></p>
                <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-medium py-3 px-8 rounded-lg">Login</button>
            </form>
        </div>
        <!-- AI Settings Management Modal -->
        <div id="admin-settings-modal" class="modal-content hidden bg-slate-800 rounded-lg p-8 shadow-2xl max-w-2xl w-full border border-slate-600 glass-card">
            <h3 class="text-2xl font-bold mb-6 text-white text-center">AI Settings Management</h3>
            
            <div class="space-y-6">
                <!-- LLM Provider Selection -->
                <div>
                    <label for="llm-provider-select" class="block text-slate-300 font-semibold mb-2">Language Model (LLM) Provider</label>
                    <select id="llm-provider-select" class="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white">
                        <option value="google">Google</option>
                        <option value="openai">OpenAI</option>
                        <option value="qwen">Qwen (Alibaba Cloud)</option>
                    </select>
                </div>

                <!-- API Key Inputs -->
                <div class="border-t border-slate-700 pt-4">
                     <h4 class="text-lg font-semibold text-slate-200 mb-3">API Keys</h4>
                     <div class="space-y-3">
                        <div><label for="google-key-input" class="block text-slate-400 font-medium mb-1">Google API Key</label><input type="password" id="google-key-input" class="w-full p-2 bg-slate-900 border border-slate-600 rounded-lg text-white"></div>
                        <div><label for="openai-key-input" class="block text-slate-400 font-medium mb-1">OpenAI API Key</label><input type="password" id="openai-key-input" class="w-full p-2 bg-slate-900 border border-slate-600 rounded-lg text-white"></div>
                        <div><label for="qwen-key-input" class="block text-slate-400 font-medium mb-1">Qwen API Key</label><input type="password" id="qwen-key-input" class="w-full p-2 bg-slate-900 border border-slate-600 rounded-lg text-white"></div>
                     </div>
                </div>
                
                <!-- Other AI Settings -->
                 <div class="border-t border-slate-700 pt-4">
                     <h4 class="text-lg font-semibold text-slate-200 mb-3">Additional Settings</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="tts-voice-select" class="block text-slate-400 font-medium mb-1">TTS Voice (OpenAI)</label>
                            <select id="tts-voice-select" class="w-full p-2 bg-slate-900 border border-slate-600 rounded-lg text-white">
                                <option value="nova">Nova</option>
                                <option value="alloy">Alloy</option>
                                <option value="echo">Echo</option>
                                <option value="fable">Fable</option>
                                <option value="onyx">Onyx</option>
                                <option value="shimmer">Shimmer</option>
                            </select>
                        </div>
                        <div>
                            <label for="image-model-select" class="block text-slate-400 font-medium mb-1">Image Generation Model</label>
                            <select id="image-model-select" class="w-full p-2 bg-slate-900 border border-slate-600 rounded-lg text-white">
                                <option value="dall-e-3">DALL-E 3 (OpenAI)</option>
                            </select>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 mt-8">
                <button id="save-settings-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg">Apply Settings</button>
                <button data-close-modal class="w-full bg-slate-600 hover:bg-slate-500 text-white font-medium py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- DOM & View Management ---
        const views = { 
            main: document.getElementById('main-view'), 
            chat: document.getElementById('chat-view'), 
            prd: document.getElementById('prd-view'), 
            experience: document.getElementById('experience-view') 
        };
        const experiencePages = { 4: document.getElementById('experience-prototype-page'), 5: document.getElementById('experience-quotation-page') };
        
        // --- DOM Element References ---
        const initialIdeaInput = document.getElementById('initial-idea-input'), startChatButton = document.getElementById('start-chat-button');
        const chatWindow = document.getElementById('chat-window'), chatInput = document.getElementById('chat-input'), sendChatButton = document.getElementById('send-chat-button'), aiThinkingIndicator = document.getElementById('ai-thinking-indicator'), finishChatButton = document.getElementById('finish-chat-button');
        const generatedPrdDiv = document.getElementById('generated-prd'), analyzeMarketButton = document.getElementById('analyze-market-button'), exportPdfButton = document.getElementById('export-pdf-button'), goToExperienceViewButton = document.getElementById('go-to-experience-view-button');
        const generateUserStoriesButton = document.getElementById('generate-user-stories-button'), generateBomButton = document.getElementById('generate-bom-button');
        const backToMainFromChat = document.getElementById('back-to-main-from-chat'), backToChat = document.getElementById('back-to-chat'), backToPrd = document.getElementById('back-to-prd');
        const appearanceKeywordTextarea = document.getElementById('appearance-keyword-textarea'), generateAppearanceButton = document.getElementById('generate-appearance-button'), sceneImageLoader = document.getElementById('scene-image-loader'), sceneProductImage = document.getElementById('scene-product-image');
        const personaTextarea = document.getElementById('persona-textarea'), applyPersonaButton = document.getElementById('apply-persona-button'), demoChatWindow = document.getElementById('demo-chat-window'), demoAiThinkingIndicator = document.getElementById('demo-ai-thinking-indicator'), demoChatInput = document.getElementById('demo-chat-input'), demoSendChatButton = document.getElementById('demo-send-chat-button'), emotionScreen = document.getElementById('emotion-screen'), emotionSelector = document.getElementById('emotion-selector');
        const goToQuotationButton = document.getElementById('go-to-quotation-button');
        const quotationForm = document.getElementById('quotation-form'), quotationSuccessMessage = document.getElementById('quotation-success-message');
        const startCreationLink = document.getElementById('start-creation-link');
        
        // Modal Elements
        const modalContainer = document.getElementById('modal-container');
        const modalContents = {
            notification: document.getElementById('notification-modal'),
            adminLogin: document.getElementById('admin-login-modal'),
            adminSettings: document.getElementById('admin-settings-modal'),
            promptHelper: document.getElementById('prompt-helper-modal'),
        };
        const modalTitle = document.getElementById('modal-title'), modalMessage = document.getElementById('modal-message');
        const openPromptHelperBtn = document.getElementById('open-prompt-helper');
        const promptHelperInput = document.getElementById('prompt-helper-input'), promptHelperGenerateBtn = document.getElementById('prompt-helper-generate-btn'), promptHelperOutputContainer = document.getElementById('prompt-helper-output-container'), promptHelperOutput = document.getElementById('prompt-helper-output'), promptHelperApplyBtn = document.getElementById('prompt-helper-apply-btn');
        const adminLoginLink = document.getElementById('admin-login-link'), adminLoginForm = document.getElementById('admin-login-form'), loginErrorMsg = document.getElementById('login-error-msg');
        
        // Admin Settings Modal Inputs
        const llmProviderSelect = document.getElementById('llm-provider-select');
        const googleKeyInput = document.getElementById('google-key-input');
        const openaiKeyInput = document.getElementById('openai-key-input');
        const qwenKeyInput = document.getElementById('qwen-key-input');
        const ttsVoiceSelect = document.getElementById('tts-voice-select');
        const imageModelSelect = document.getElementById('image-model-select');
        const saveSettingsBtn = document.getElementById('save-settings-btn');


        // --- AI Configuration ---
        let settings = {};

        const defaultSettings = {
            activeLLM: 'google',
            apiKeys: {
                google: 'AIzaSyBC-_nKYd3w5U-HHNUs-5OHx-Zp9ChmYR0',
                openai: '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',
                qwen: 'sk-ccbe7969cdff4c88bb16e04728f184f5'
            },
            tts: {
                voice: 'nova'
            },
            imageGen: {
                model: 'dall-e-3'
            }
        };
        
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem('ai_settings');
                if (storedSettings) {
                    settings = JSON.parse(storedSettings);
                } else {
                    settings = JSON.parse(JSON.stringify(defaultSettings)); // Deep copy
                }
            } catch (e) {
                console.error("Failed to load settings, using defaults.", e);
                settings = JSON.parse(JSON.stringify(defaultSettings));
            }
        }
        
        function saveSettings() {
            try {
                localStorage.setItem('ai_settings', JSON.stringify(settings));
                showNotification("Success", "AI settings have been updated and applied.");
            } catch (e) {
                console.error("Failed to save settings.", e);
                showNotification("Error", "Could not save settings to local storage.");
            }
        }

        // --- State Management ---
        let chatHistory = [];
        let demoChatHistory = [];
        let finalProductPRD = "";
        let currentStep = 1;
        const defaultPRD = "This is an AI smart coffee machine. Its target users are young professionals who pursue a high-quality lifestyle. Core features include customizing coffee strength, temperature, and milk foam volume via voice commands or a mobile app. It can also learn user preferences and proactively recommend coffee. In terms of design, it has a stylish metal appearance and a small touch interaction screen.";
        let isMainImageGenerated = false;

        // --- Flow Control ---
        function showView(viewName) {
            Object.keys(views).forEach(key => views[key].classList.toggle('active', key === viewName));
            window.scrollTo(0,0);
        }

        function updateStepUI(step) {
            currentStep = step;
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`step-icon-${i}`)?.classList.toggle('active', i <= currentStep);
            }
        }
        
        function showStep(step) {
            updateStepUI(step);
            if (step === 1) showView('main');
            else if (step === 2) showView('chat');
            else if (step === 3) showView('prd');
            else if (step === 4 || step === 5) {
                showView('experience');
                Object.values(experiencePages).forEach(p => p.classList.add('hidden'));
                if(experiencePages[step]) experiencePages[step].classList.remove('hidden');
            }
        }

        document.querySelectorAll('.step-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const targetStep = parseInt(link.id.split('-')[2], 10);
                if (targetStep === 4) {
                    setupExperienceView(true); // isDemo = true
                    return;
                }
                if (targetStep <= currentStep) {
                    showStep(targetStep);
                } else {
                    showNotification("Process Tip", "Please complete the current step in order to access subsequent steps.");
                }
            });
        });

        // --- Modal Management ---
        function showModal(modalId, title, message) {
            Object.values(modalContents).forEach(mc => mc.classList.add('hidden'));
            const targetModal = document.getElementById(modalId);
            if (targetModal) {
                if (title && modalTitle) modalTitle.textContent = title;
                if (message && modalMessage) modalMessage.innerHTML = message;
                targetModal.classList.remove('hidden');
                modalContainer.classList.remove('hidden');
            }
        }

        function closeModal() {
            modalContainer.classList.add('hidden');
        }

        document.querySelectorAll('[data-close-modal]').forEach(btn => {
            btn.addEventListener('click', closeModal);
        });
        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) closeModal();
        });

        function showNotification(title, message) { showModal('notification-modal', title, message); }
        
        // --- Utility Functions ---
        function appendMessage(windowEl, sender, text) { 
            const container = document.createElement('div'); 
            const bubble = document.createElement('div'); 
            bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`; 
            bubble.innerHTML = marked.parse(text); 
            container.appendChild(bubble); 
            windowEl.appendChild(container); 
            windowEl.scrollTop = windowEl.scrollHeight;
            return bubble; 
        }

        function setChatUiLock(isLocked, chatInputEl, sendButtonEl, thinkingIndicatorEl) { 
            chatInputEl.disabled = isLocked; 
            sendButtonEl.disabled = isLocked; 
            thinkingIndicatorEl.classList.toggle('hidden', !isLocked); 
        }

        // --- API Calls ---
        async function playAudio(text) {
            if (!settings.apiKeys.openai) { console.error("OpenAI API Key not set for TTS."); return; }
            try {
                const response = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${settings.apiKeys.openai}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ model: 'tts-1-hd', input: text, voice: settings.tts.voice })
                });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || `OpenAI TTS API request failed`); }
                const blob = await response.blob();
                new Audio(URL.createObjectURL(blob)).play();
            } catch (error) { console.error("Audio playback failed:", error); showNotification('Audio Playback Failed', `Could not play AI voice: ${error.message}`); }
        }

        async function callTextApi({history, elementToUpdate, isStream = true, withTTS = false}) {
            const provider = settings.activeLLM;
            const apiKey = settings.apiKeys[provider];

            if (!apiKey) {
                const errorMsg = `API Key for ${provider.toUpperCase()} is not configured. Please set it in the admin panel.`;
                showNotification("API Error", errorMsg);
                if (elementToUpdate) elementToUpdate.innerHTML = `<p class="text-red-400">${errorMsg}</p>`;
                return null;
            }

            // Specific check for Qwen due to CORS limitation
            if (provider === 'qwen') {
                const errorMsg = "Direct browser calls to the Qwen (Alibaba Cloud) API are blocked by its security policy (CORS). This integration requires a server-side proxy to function correctly, which cannot be implemented in this environment.";
                showNotification("Integration Blocked", errorMsg);
                if (elementToUpdate) elementToUpdate.innerHTML = `<p class="text-red-400">${errorMsg}</p>`;
                return null;
            }

            let loadingBubble;
            if (isStream && elementToUpdate) {
                loadingBubble = appendMessage(elementToUpdate, 'assistant', '');
            } else if (elementToUpdate) {
                elementToUpdate.innerHTML = '<div class="flex items-center justify-center gap-3"><div class="loader"></div><p>AI is generating content...</p></div>';
            }

            let requestUrl, requestOptions;
            let fullResponse = "";

            try {
                switch (provider) {
                    case 'google':
                        requestUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:streamGenerateContent?key=${apiKey}&alt=sse`;
                        requestOptions = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: history.map(item => ({
                                role: item.role === 'assistant' ? 'model' : 'user',
                                parts: [{ text: item.content }]
                            })).filter(item => item.parts[0].text.trim() !== '') })
                        };
                        break;
                    
                    case 'openai':
                        requestUrl = 'https://api.openai.com/v1/chat/completions';
                        requestOptions = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'gpt-4-turbo', messages: history, stream: true })
                        };
                        break;
                    
                    default:
                        throw new Error(`Unsupported LLM provider: ${provider}`);
                }

                const response = await fetch(requestUrl, requestOptions);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: `Request failed with status ${response.status}` } }));
                    throw new Error(errorData.error.message || `API request failed`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '' || !line.includes('data:')) continue;
                        
                        const dataJson = line.replace(/^data: /, '').trim();
                        if (dataJson === '[DONE]') break;
                        
                        try {
                            const data = JSON.parse(dataJson);
                            let textPart = '';
                            if (provider === 'google') {
                                textPart = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                            } else if (provider === 'openai') {
                                textPart = data.choices?.[0]?.delta?.content || '';
                            }
                            if (textPart) {
                                fullResponse += textPart;
                            }
                        } catch (e) {
                             // Ignore parsing errors for incomplete JSON
                        }
                    }
                    if (loadingBubble) {
                        loadingBubble.innerHTML = marked.parse(fullResponse);
                        elementToUpdate.scrollTop = elementToUpdate.scrollHeight;
                    }
                }
                
                if (loadingBubble) { loadingBubble.innerHTML = marked.parse(fullResponse); }
                if (withTTS && fullResponse) { await playAudio(fullResponse); }
                return fullResponse;

            } catch (error) {
                const errorMessage = `Error with ${provider.toUpperCase()} API: ${error.message}`;
                if (loadingBubble) { loadingBubble.innerHTML = `<p class="text-red-400">${errorMessage}</p>`; } 
                else if (elementToUpdate) { elementToUpdate.innerHTML = `<p class="text-red-400">${errorMessage}</p>`; }
                showNotification('API Communication Error', errorMessage);
                return null;
            }
        }

        async function callOpenAIImageApi(prompt, loaderElement, imageElement) {
            const apiKey = settings.apiKeys.openai;
            if (!apiKey) {
                showNotification("API Error", "OpenAI API Key is not configured. Please set it in the admin panel.");
                return;
            }
            loaderElement.classList.remove('hidden');
            if(imageElement) imageElement.style.opacity = '0.5';
            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({ model: settings.imageGen.model, prompt: prompt, n: 1, size: "1792x1024", response_format: "b64_json" })
                });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || `DALL-E 3 API request failed`); }
                const result = await response.json();
                const b64_json = result.data[0].b64_json;
                if (b64_json) { const imageUrl = `data:image/png;base64,${b64_json}`; if(imageElement) { imageElement.src = imageUrl; isMainImageGenerated = true; } return imageUrl; } 
                else { throw new Error('Could not get valid image data from OpenAI API.'); }
            } catch (error) {
                showNotification('Image Generation Failed', `Error communicating with DALL-E 3: ${error.message}`);
                if (imageElement) imageElement.src = `https://placehold.co/1792x1024/0f172a/9ca3af?text=Generation+Failed`;
            } finally { loaderElement.classList.add('hidden'); if(imageElement) imageElement.style.opacity = '1'; }
        }

        // --- Core Logic ---
        function initializeChat() { 
            const userInput = initialIdeaInput.value.trim();
            if (!userInput) { showNotification('Input Error', 'Please enter your initial idea to start the conversation.'); return; }
            showStep(2);
            const systemPrompt = `You are a seasoned AI hardware Product Manager. Your task is to guide the user through a multi-turn conversation to clarify their product idea. Your responses should be short, friendly, and professional. Use Markdown bold format (e.g., **keyword**) to highlight what you consider to be important product features, user needs, or key decision points.`;
            chatHistory = [ { role: "system", content: systemPrompt } ];
            appendMessage(chatWindow, 'user', userInput);
            chatHistory.push({ role: "user", content: userInput });
            getAiResponse();
        }

        async function getAiResponse() { 
            setChatUiLock(true, chatInput, sendChatButton, aiThinkingIndicator);
            const responseText = await callTextApi({ history: chatHistory, elementToUpdate: chatWindow, isStream: true });
            if (responseText) { chatHistory.push({ role: "assistant", content: responseText }); }
            setChatUiLock(false, chatInput, sendChatButton, aiThinkingIndicator); chatInput.focus();
        }
        
        async function handleSendMessage() {  
            const userInput = chatInput.value.trim(); if (!userInput) return; 
            appendMessage(chatWindow, 'user', userInput); 
            chatHistory.push({ role: "user", content: userInput }); 
            chatInput.value = ''; await getAiResponse(); 
        }

        async function handleGeneratePRD() { 
            showStep(3);
            const finalPrompt = `Based on our entire conversation history, please summarize and generate a professional, detailed, and structured final Product Requirement Document (PRD). If information is insufficient, use your professional product manager expertise to reasonably expand and complete it based on the initial idea. Ensure the document is complete. Include: Product Overview, Target Audience, Functional Requirements (with priority), Non-functional Requirements, and Product Form & Design Suggestions. Use Markdown format and do not include any additional conversational text.`; 
            const messages = [...chatHistory, {role: 'user', content: finalPrompt}];
            finalProductPRD = await callTextApi({ history: messages, elementToUpdate: generatedPrdDiv, isStream: true }) || "";
        }

        async function handleSectionGeneration(button, promptTemplate, sectionTitle) {
            button.disabled = true; button.innerHTML = '<div class="loader inline-block"></div> Generating...';
            const prdContent = generatedPrdDiv.innerText;
            if (!prdContent) { showNotification("Error", "PRD content is empty. Please generate the main document first."); button.disabled = false; button.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>Generation Failed`; return; }
            const prompt = promptTemplate.replace('${PRD_CONTENT}', prdContent);
            const sectionContainer = document.createElement('div');
            sectionContainer.innerHTML = `<hr class="my-8 border-dashed border-slate-600">`;
            const contentDiv = document.createElement('div');
            sectionContainer.appendChild(contentDiv);
            generatedPrdDiv.appendChild(sectionContainer);
            const newText = await callTextApi({ history: [{role: 'user', content: prompt}], elementToUpdate: contentDiv, isStream: true });
            if (newText) { finalProductPRD += `\n\n---\n\n${newText}`; button.innerHTML = `<i class="fas fa-check mr-2"></i>Generated ${sectionTitle}`; } 
            else { button.innerHTML = `<i class="fas fa-times mr-2"></i>Generation Failed`; }
            button.disabled = false;
        }

        async function handleMarketAnalysis() { await handleSectionGeneration(analyzeMarketButton, `Based on the following PRD, provide a market potential analysis. Focus on target market size, key competitors, and unique selling propositions. PRD: \n\n\${PRD_CONTENT}`, "Market Analysis"); }
        async function handleGenerateUserStories() { await handleSectionGeneration(generateUserStoriesButton, `Based on the following PRD, create a set of user stories. For each story, follow the format: "As a [type of user], I want [an action] so that [a benefit]". PRD: \n\n\${PRD_CONTENT}`, "User Stories"); }
        async function handleGenerateBOM() { await handleSectionGeneration(generateBomButton, `Based on the following PRD, generate a high-level, estimated Bill of Materials (BOM). List key components (e.g., microcontrollers, sensors, displays, casing materials) and suggest possible options. This is for estimation purposes. PRD: \n\n\${PRD_CONTENT}`, "Bill of Materials"); }

        async function setupExperienceView(isDemo = false) { 
            let prdToUse = finalProductPRD || (isDemo ? defaultPRD : '');
            if (!prdToUse) { showNotification("Error", "Please generate the PRD document first."); return; }
            showStep(4);
            personaTextarea.value = "Extracting AI persona prompt..."; 
            appearanceKeywordTextarea.value = "Extracting product appearance keywords...";
            const personaPrompt = `From the following PRD, create a character definition and system prompt for the product's AI assistant. This definition should be clear, concise, and include its personality, speaking style, and main tasks. Please output only the text of the character definition, without any other conversational text. PRD content:\n\n${prdToUse}`; 
            callTextApi({history: [{role:'user', content: personaPrompt}]}).then(text => { if(text) personaTextarea.value = text; });
            const scenePrompt = `Based on the following Product Requirement Document (PRD), extract a series of keywords describing the product's appearance for AI image generation. Please only use commas to separate these keywords. Do not include any other text. PRD:\n\n${prdToUse}`; 
            callTextApi({history: [{role:'user', content: scenePrompt}]}).then(text => { if(text) appearanceKeywordTextarea.value = text; }); 
        }

        async function generateProductImage() {
            const productKeywords = appearanceKeywordTextarea.value.trim();
            if (!productKeywords) { showNotification("Error", "Product appearance keywords cannot be empty."); return; }
            const finalPrompt = `${productKeywords}, product photography, studio shot, on a clean white background, minimalist, no logo, no branding, no props, professional studio lighting, soft shadows, photorealistic`;
            await callOpenAIImageApi(finalPrompt, sceneImageLoader, sceneProductImage);
        }

        async function applyAndStartPersona() { 
            const personaPrompt = personaTextarea.value.trim(); if (!personaPrompt) {showNotification("Error", "AI persona prompt cannot be empty."); return;} 
            demoChatHistory = [{ role: "system", content: personaPrompt }]; demoChatWindow.innerHTML = ''; 
            let prdToUse = finalProductPRD || defaultPRD;
            const openingLinePrompt = `Based on the following PRD, create a natural, engaging opening line for a user to start a conversation with the product's AI assistant. The line should be from the user's perspective. Output only the opening line text. PRD:\n\n${prdToUse}`;
            const openingLine = await callTextApi({history: [{ role: 'user', content: openingLinePrompt }]});
            if (openingLine) { appendMessage(demoChatWindow, 'user', openingLine); demoChatHistory.push({ role: "user", content: openingLine }); await getDemoAiResponse(); } 
            else { showNotification("Error", "Could not generate opening line."); }
        }

        async function analyzeEmotion(text) {
            const prompt = `Analyze the emotion of the following text. Please respond with only a single emoji that best represents the emotion. For example, if the text is happy, respond with "ðŸ˜Š". If sad, "ðŸ˜¢". If it provides help or information, use "ðŸ’¡". If surprised, "ðŸ˜®". For a simple acknowledgment, use "ðŸ™‚". Do not include any other text or explanation. The text is: "${text}"`;
            const emoji = await callTextApi({history: [{ role: 'user', content: prompt }]});
            emotionScreen.textContent = emoji || 'ðŸ™‚';
        }

        async function getDemoAiResponse() {
            setChatUiLock(true, demoChatInput, demoSendChatButton, demoAiThinkingIndicator);
            const responseText = await callTextApi({ history: demoChatHistory, elementToUpdate: demoChatWindow, isStream: true, withTTS: true });
            if(responseText) { demoChatHistory.push({ role: "assistant", content: responseText }); analyzeEmotion(responseText); }
            setChatUiLock(false, demoChatInput, demoSendChatButton, demoAiThinkingIndicator);
        }

        async function handleDemoChatSend() { 
            const userInput = demoChatInput.value.trim(); if (!userInput) return; 
            appendMessage(demoChatWindow, 'user', userInput); demoChatHistory.push({ role: "user", content: userInput });
            demoChatInput.value = ''; await getDemoAiResponse();
        }
        
        // --- Init & Event Listeners ---
        loadSettings();
        showStep(1); 
        startChatButton.onclick = initializeChat; 
        sendChatButton.onclick = handleSendMessage; 
        chatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } };
        finishChatButton.onclick = handleGeneratePRD; 
        analyzeMarketButton.onclick = handleMarketAnalysis; 
        generateUserStoriesButton.onclick = handleGenerateUserStories;
        generateBomButton.onclick = handleGenerateBOM;
        exportPdfButton.onclick = () => showNotification("Feature in Development", "The Export to PDF feature is currently in development.");
        goToExperienceViewButton.onclick = () => setupExperienceView(false); 
        backToMainFromChat.onclick = () => showStep(1);
        backToChat.onclick = () => showStep(2);
        backToPrd.onclick = () => showStep(3);
        generateAppearanceButton.onclick = generateProductImage;
        applyPersonaButton.onclick = applyAndStartPersona;
        demoSendChatButton.onclick = handleDemoChatSend; 
        demoChatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleDemoChatSend(); } };
        goToQuotationButton.onclick = () => showStep(5);
        startCreationLink.onclick = (e) => { e.preventDefault(); document.querySelector('#creation-process').scrollIntoView({ behavior: 'smooth' }); };
        
        quotationForm.addEventListener('submit', (e) => {
             e.preventDefault(); 
             const email = document.getElementById('user-email').value;
             const contact = document.getElementById('user-contact').value;
             const requirements = document.getElementById('user-additional-requirements').value;
             const finalDocument = `...`; // Same as before
             console.log("Project quote data packaged (simulated send):", {fullDocument: finalDocument});
             document.getElementById('quotation-form-container').classList.add('hidden');
             quotationSuccessMessage.classList.remove('hidden'); 
        });

        // Prompt Helper Logic
        openPromptHelperBtn.addEventListener('click', () => showModal('prompt-helper-modal'));
        promptHelperGenerateBtn.addEventListener('click', async () => { /* ... same as before */ });
        promptHelperApplyBtn.addEventListener('click', () => { /* ... same as before */ });
        
        // --- Admin & Settings Logic ---
        adminLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            showModal('admin-login-modal');
        });

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            if (username === 'finewood' && password === 'alove123') {
                closeModal();
                // Populate and show the settings modal
                llmProviderSelect.value = settings.activeLLM;
                googleKeyInput.value = settings.apiKeys.google;
                openaiKeyInput.value = settings.apiKeys.openai;
                qwenKeyInput.value = settings.apiKeys.qwen;
                ttsVoiceSelect.value = settings.tts.voice;
                imageModelSelect.value = settings.imageGen.model;
                showModal('admin-settings-modal');
            } else {
                loginErrorMsg.textContent = "Incorrect username or password.";
                loginErrorMsg.classList.remove('hidden');
            }
        });

        saveSettingsBtn.addEventListener('click', () => {
            // Update settings object from form
            settings.activeLLM = llmProviderSelect.value;
            settings.apiKeys.google = googleKeyInput.value.trim();
            settings.apiKeys.openai = openaiKeyInput.value.trim();
            settings.apiKeys.qwen = qwenKeyInput.value.trim();
            settings.tts.voice = ttsVoiceSelect.value;
            settings.imageGen.model = imageModelSelect.value;
            
            saveSettings();
            closeModal();
        });

        // Initialize emotion selector
        const emotions = ['ðŸ™‚', 'ðŸ˜Š', 'ðŸ’¡', 'ðŸ¤”', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ‘', 'ðŸ˜'];
        emotionSelector.innerHTML = '';
        emotions.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emotion-choice';
            span.textContent = emoji;
            span.onclick = () => { emotionScreen.textContent = emoji; };
            emotionSelector.appendChild(span);
        });
    });
    </script>
</body>
</html>
