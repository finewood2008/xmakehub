<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMAKEHUB AI造物所 - 从Prompt到Product</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --tech-blue: #0ea5e9; /* sky-500 */
            --vibrant-orange: #f97316; /* orange-500 */
            --dark-bg: #0c112b; /* A dark navy blue */
            --card-bg: rgba(22, 29, 63, 0.5); 
            --border-color: rgba(56, 189, 248, 0.2);
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--dark-bg);
            color: #d1d5db; /* gray-300 */
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 25px 25px;
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .gradient-text {
            background: linear-gradient(90deg, var(--tech-blue) 0%, var(--vibrant-orange) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .loader, .prompt-loader {
            border: 4px solid #374151; /* gray-700 */
            border-top: 4px solid var(--tech-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .prompt-loader { width: 16px; height: 16px; border-width: 2px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }

        #chat-window { 
            height: calc(100vh - 300px);
            overflow-y: auto;
        }
        #demo-chat-window { 
            height: 200px; 
            overflow-y: auto; 
        }
        .chat-bubble { max-width: 90%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }
        .user-bubble { background-color: var(--tech-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-bubble { background-color: #374151; /* gray-700 */ color: #d1d5db; align-self: flex-start; border-bottom-left-radius: 4px; }
        .ai-bubble strong { color: var(--tech-blue); }
        
        .prose { color: #d1d5db; }
        .prose h1, .prose h2 { color: white; border-bottom: 1px solid #4b5563; padding-bottom: 0.5em; margin-bottom: 1em; }
        .prose h3, .prose h4, .prose h5, .prose h6 { color: #93c5fd; margin-top: 2em; margin-bottom: 1em; }
        .prose strong { color: var(--tech-blue); }
        .prose ul > li::before { background-color: var(--tech-blue); }
        .prose p, .prose ul, .prose ol { line-height: 1.7; }
        .prose hr { border-color: #4b5563; }

        .step-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 5rem;
            height: 5rem;
            background-color: rgba(255, 255, 255, 0.05);
            color: #6b7280;
            border-radius: 50%;
            font-size: 1.875rem;
            margin-bottom: 1rem;
            border: 2px solid #374151;
            transition: all 0.3s ease-in-out;
            position: relative;
        }
        .step-icon.active {
            background-color: var(--tech-blue);
            color: white;
            border-color: var(--tech-blue);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); }
            50% { box-shadow: 0 0 35px 10px rgba(249, 115, 22, 0.7); }
        }
        .step-icon.emphasized {
            background-color: var(--vibrant-orange);
            color: white;
            border-color: var(--vibrant-orange);
            animation: pulse 2s infinite;
        }
        .step-link { cursor: pointer; }
        
        .emotion-choice {
            cursor: pointer;
            font-size: 1.75rem;
            transition: all 0.2s ease-in-out;
            padding: 4px;
            border-radius: 8px;
        }
        .emotion-choice:hover {
            transform: scale(1.25);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .prompt-generator-icon {
            cursor: pointer;
            color: #f97316;
            margin-left: 0.5rem;
            transition: transform 0.2s;
        }
        .prompt-generator-icon:hover {
            transform: scale(1.2);
        }
        
    </style>
</head>
<body class="min-h-screen">
    
    <!-- 主视图 -->
    <div id="main-view" class="view active">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10">
            <div class="container mx-auto px-4 py-4">
                <div class="text-xl font-bold text-white"><i class="fas fa-atom mr-2 gradient-text"></i>XMAKEHUB <span class="gradient-text">AI造物所</span></div>
            </div>
        </nav>
        <main class="container mx-auto px-4 py-6">
            <!-- 英雄区 -->
            <section class="text-center py-12 md:py-16 rounded-2xl">
                <h1 class="text-5xl md:text-7xl font-black mb-4 text-white">AI造物所</h1>
                <p class="text-lg md:text-xl text-slate-300 max-w-3xl mx-auto mb-6 font-semibold">用一句话打造一款AI硬件，<span class="gradient-text">从 Prompt 到 Product</span></p>
                <p class="text-base text-slate-400 max-w-2xl mx-auto mb-8">在这里，您的任何一个硬件构想，都能通过与我们先进的 AI 产品经理深度协作，从一个模糊的念头，一步步变为详尽的规格、逼真的原型，直至最终的商业评估。</p>
                <div>
                    <a href="#creation-process" id="start-creation-link" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg shadow-sky-500/30 transform hover:scale-105 transition-transform">立即开启 <i class="fas fa-rocket ml-2"></i></a>
                </div>
            </section>

            <!-- 实现流程 -->
            <section id="how-it-works" class="py-12">
                <h2 class="text-3xl font-bold text-center mb-12 text-white">实现流程</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-8 text-center relative">
                    <!-- Dashed line connector for desktop -->
                    <div class="hidden md:block absolute top-1/2 left-0 w-full h-px" style="transform: translateY(-5rem);">
                         <svg width="100%" height="2" class="absolute top-1/2 left-0" style="transform: translateY(-50%);">
                            <line x1="10%" y1="1" x2="90%" y2="1" stroke-width="2" stroke-dasharray="8 8" class="stroke-slate-600"/>
                        </svg>
                    </div>
                    <a id="step-link-1" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-1" class="step-icon"><i class="fas fa-lightbulb"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">1. 提出构想</h3>
                        <p class="text-slate-400 text-sm">用一句话描述您的产品灵感。</p>
                    </a>
                    <a id="step-link-2" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-2" class="step-icon"><i class="fas fa-comments"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">2. AI深度对话</h3>
                        <p class="text-slate-400 text-sm">与AI产品经理沟通，明确细节。</p>
                    </a>
                    <a id="step-link-3" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-3" class="step-icon"><i class="fas fa-file-alt"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">3. 生成PRD文档</h3>
                        <p class="text-slate-400 text-sm">一键生成专业的产品需求文档。</p>
                    </a>
                    <a id="step-link-4" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-4" class="step-icon emphasized"><i class="fas fa-vr-cardboard"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">4. 沉浸式体验</h3>
                        <p class="text-slate-400 text-sm">体验原型、生成渲染图。</p>
                    </a>
                    <a id="step-link-5" class="step-link flex flex-col items-center z-10">
                        <div id="step-icon-5" class="step-icon"><i class="fas fa-tags"></i></div>
                        <h3 class="font-semibold text-lg text-white mb-2">5. 原型报价</h3>
                        <p class="text-slate-400 text-sm">获取生产报价并启动项目。</p>
                    </a>
                </div>
            </section>
            
            <section id="creation-process" class="glass-card p-6 md:p-8 mt-8">
                 <h2 class="text-3xl font-bold mb-6 flex items-center text-white"><span class="ml-4">提出您的初步构想</span></h2>
                 <textarea id="initial-idea-input" class="w-full h-32 p-4 border bg-slate-800 border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="请简单描述您的产品构想，例如：我想开发一款带AI功能的智能咖啡机..."></textarea>
                 <div class="mt-4 flex justify-center">
                     <button id="start-chat-button" class="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-medium py-3 px-8 rounded-lg transition-colors flex items-center justify-center">开始与AI产品经理对话 <i class="fas fa-comments ml-2"></i></button>
                 </div>
            </section>
        </main>
        <footer class="bg-slate-900/50 text-white py-12 mt-16">
            <div class="container mx-auto px-4 text-center text-slate-400"><p>© 2025 XMAKEHUB AI造物所. 保留所有权利.</p></div>
        </footer>
    </div>
    
    <!-- 对话视图 -->
    <div id="chat-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-xl font-bold text-white"><i class="fas fa-comments mr-2 gradient-text"></i>与 AI 产品经理对话</div><button id="back-to-main-from-chat" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>返回首页</button></div></nav>
        <main class="container mx-auto p-4">
             <div class="border border-slate-700 rounded-lg p-4 flex flex-col glass-card">
                <div id="chat-window" class="flex flex-col gap-4 mb-4 pr-2"></div>
                <div id="ai-thinking-indicator" class="hidden flex items-center gap-3 self-start my-2"><div class="ai-bubble loader !p-3"></div><p class="text-slate-400 text-sm">正在输入...</p></div>
                <div class="pt-4 border-t border-slate-700 mt-2">
                     <div class="flex items-center gap-3">
                        <input id="chat-input" type="text" class="flex-grow w-full p-3 border bg-slate-800 border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="请在这里输入您的想法或回答...">
                        <button id="send-chat-button" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-lg transition-colors flex items-center justify-center">发送 <i class="fas fa-paper-plane ml-2"></i></button>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-center"><button id="finish-chat-button" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg transition-colors">需求已明确，生成PRD文档 <i class="fas fa-file-alt ml-2"></i></button></div>
        </main>
    </div>

    <!-- PRD 视图 -->
    <div id="prd-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-xl font-bold text-white"><i class="fas fa-file-alt mr-2 gradient-text"></i>产品需求文档 (PRD)</div><button id="back-to-chat" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>返回对话</button></div></nav>
        <main class="container mx-auto p-4">
             <div class="glass-card p-6 md:p-8">
                 <div id="generated-prd" contenteditable="true" class="p-6 bg-slate-900 rounded-lg border border-slate-700 prose max-w-none focus:ring-2 focus:ring-sky-500 min-h-[50vh]"></div>
                 <div id="prd-actions" class="flex flex-wrap gap-4 mt-6">
                     <button id="generate-user-stories-button" class="bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-users mr-2"></i>生成用户故事</button>
                     <button id="generate-bom-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-microchip mr-2"></i>生成物料清单 (BOM)</button>
                     <button id="analyze-market-button" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-chart-line mr-2"></i>分析市场潜力</button>
                     <button id="export-pdf-button" class="bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-file-pdf mr-2"></i>导出为PDF</button>
                 </div>
                 <h2 class="text-2xl font-bold mt-12 mb-6 flex items-center text-white"><span class="ml-4">下一步：沉浸式体验</span></h2>
                 <p class="text-slate-400 mb-4">进入一个全新的沉浸式体验中心，将您的构想化为现实，并获取报价。</p>
                 <button id="go-to-experience-view-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-8 rounded-lg transition-colors text-lg">进入体验与报价中心 <i class="fas fa-vr-cardboard ml-2"></i></button>
            </div>
        </main>
    </div>

    <!-- 体验与原型视图 -->
    <div id="experience-view" class="view">
        <nav class="sticky top-0 z-50 bg-slate-900/60 backdrop-blur-sm shadow-lg shadow-blue-500/10"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="text-xl font-bold text-white"><i class="fas fa-atom mr-2 gradient-text"></i>原型体验与报价中心</div><button id="back-to-prd" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-5 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>返回PRD</button></div></nav>
        <main class="container mx-auto px-4 py-8">
            <div id="experience-prototype-page">
                <h2 class="text-3xl font-bold mb-8 text-center text-white">4. 沉浸式体验</h2>
                
                <section class="glass-card p-6 md:p-8">
                    <!-- Top: Large Image Frame -->
                    <div id="immersive-image-container" class="w-full max-w-4xl mx-auto bg-slate-900 rounded-lg p-4 relative aspect-[16/9] flex items-center justify-center border border-slate-700 mb-8">
                        <div id="scene-image-loader" class="hidden absolute inset-0 bg-slate-900/80 flex-col items-center justify-center rounded-lg">
                            <div class="loader"></div>
                            <p class="mt-4 text-slate-400">AI 正在全力绘图中...</p>
                        </div>
                        <img id="scene-product-image" src="https://placehold.co/1792x1024/0f172a/9ca3af?text=产品效果图" alt="产品效果图" class="max-w-full max-h-full object-contain rounded" onerror="this.onerror=null;this.src='https://placehold.co/1792x1024/e2e8f0/334155?text=图片加载失败';">
                    </div>

                    <!-- Middle: Dialogue Simulator and Emotion Screen -->
                    <div class="flex flex-col md:flex-row gap-8 mb-8">
                        <div class="flex-grow">
                            <h4 class="font-semibold text-lg mb-4 text-white">产品AI对话模拟器</h4>
                            <div class="border border-slate-700 rounded-lg p-4 flex flex-col bg-slate-900/50 h-full">
                                <div id="demo-chat-window" class="flex flex-col gap-4 mb-4 pr-2 flex-grow"></div>
                                <div id="demo-ai-thinking-indicator" class="hidden flex items-center gap-3 self-start mt-2"><div class="ai-bubble loader !p-3"></div><p class="text-slate-400 text-sm">正在输入...</p></div>
                                <div class="flex items-center gap-3 pt-4 border-t border-slate-700 mt-4">
                                    <input id="demo-chat-input" type="text" class="flex-grow w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white" placeholder="与您的AI助手对话...">
                                    <button id="demo-send-chat-button" class="bg-sky-500 hover:bg-sky-600 text-white font-medium p-3 rounded-lg flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-1/5 flex flex-col items-center flex-shrink-0">
                            <h4 class="font-semibold text-lg mb-4 text-white">AI 情绪</h4>
                             <div id="emotion-screen" class="w-full aspect-square bg-slate-900 rounded-2xl flex items-center justify-center text-7xl shadow-inner border border-slate-700 mb-4">
                                 🙂
                             </div>
                             <div id="emotion-selector" class="flex flex-wrap gap-3 justify-center">
                                <!-- 表情符号将由JS动态填充 -->
                             </div>
                        </div>
                    </div>
                    
                    <!-- Bottom: Prompt Controls -->
                     <hr class="my-8 border-slate-700"/>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <div>
                            <label for="persona-textarea" class="block text-slate-300 font-semibold mb-2">AI设定</label>
                            <textarea id="persona-textarea" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 text-white"></textarea>
                            <button id="apply-persona-button" class="w-full mt-2 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-6 rounded-lg">应用角色并开始对话</button>
                         </div>
                         <div>
                             <div class="flex items-center mb-2">
                                <label for="appearance-keyword-textarea" class="block text-slate-300 font-semibold">产品外观设定</label>
                                <span id="open-prompt-helper" class="prompt-generator-icon ml-2" title="AI提示词助手"><i class="fas fa-lightbulb"></i></span>
                             </div>
                             <textarea id="appearance-keyword-textarea" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white"></textarea>
                             <button id="generate-appearance-button" class="w-full mt-2 bg-sky-500 hover:bg-sky-600 text-white font-medium py-3 px-6 rounded-lg">生成产品效果图</button>
                         </div>
                     </div>
                </section>
                
                <div class="text-center mt-12"><button id="go-to-quotation-button" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg text-lg">下一步：原型生产与报价 <i class="fas fa-arrow-right ml-2"></i></button></div>
            </div>
            <div id="experience-quotation-page" class="hidden">
                 <h2 class="text-3xl font-bold mb-6 flex items-center text-white"><span class="ml-4">5. 获取专业报价</span></h2>
                 <div class="glass-card p-6 md:p-8">
                     <div id="quotation-form-container">
                         <h3 class="text-2xl font-bold mb-4 text-white">最终确认与提交</h3>
                         <p class="text-slate-400 mb-6">请在下方补充您的最终需求。提交后，我们会将所有项目资料（PRD、效果图、AI设定及补充说明）打包，我们的项目顾问将尽快与您联系并提供报价。</p>
                         <form id="quotation-form">
                            <div class="mb-6">
                                <label for="user-additional-requirements" class="block text-slate-300 font-semibold mb-2">需求补充说明</label>
                                <textarea id="user-additional-requirements" class="w-full h-40 p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="您可以在此输入任何额外的需求、规格或特殊说明..."></textarea>
                            </div>
                             <div class="mb-4">
                                <label for="user-email" class="block text-slate-300 font-semibold mb-2">邮箱地址</label>
                                <input type="email" id="user-email" class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="example@email.com" required>
                            </div>
                             <div class="mb-6">
                                <label for="user-contact" class="block text-slate-300 font-semibold mb-2">其他联系方式 (电话, 微信等)</label>
                                <input type="text" id="user-contact" class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 text-white" placeholder="您的电话号码或微信号">
                            </div>
                             <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg text-lg">提交项目以获取报价</button>
                         </form>
                     </div>
                     <div id="quotation-success-message" class="hidden text-center py-10">
                          <div class="text-6xl text-green-500 mb-4"><i class="fas fa-check-circle"></i></div>
                          <h3 class="text-2xl font-bold mb-2 text-white">项目资料已成功提交！</h3>
                          <p class="text-slate-400">感谢您的提交！我们已收到您的完整项目资料，专属项目顾问将在24小时内通过您提供的联系方式与您沟通并提供报价。</p>
                     </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- 提示词助手模态框 -->
    <div id="prompt-helper-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg p-8 shadow-2xl max-w-2xl w-full border border-slate-600 glass-card">
            <h3 class="text-xl font-bold mb-4 text-white">AI提示词助手</h3>
            <p class="text-slate-400 mb-4">请在下方用任何语言描述您想要的产品外观，AI会为您生成专业的英文提示词。</p>
            <textarea id="prompt-helper-input" class="w-full h-32 p-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 text-white" placeholder="例如：一个白色的、极简风格的咖啡机，带有木质底座和圆形触摸屏..."></textarea>
            <button id="prompt-helper-generate-btn" class="w-full mt-4 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-6 rounded-lg flex items-center justify-center">
                <span class="btn-text">自动生成提示词</span>
                <div class="loader hidden ml-2"></div>
            </button>
            <div id="prompt-helper-output-container" class="mt-4 hidden">
                <label class="block text-slate-300 font-semibold mb-2">生成的提示词:</label>
                <div id="prompt-helper-output" class="p-3 bg-slate-900 rounded-lg border border-slate-600 text-slate-300 min-h-[6rem]"></div>
            </div>
            <div class="flex gap-4 mt-6">
                <button id="prompt-helper-apply-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-6 rounded-lg disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>应用提示词</button>
                <button id="prompt-helper-close-btn" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-medium py-2 px-6 rounded-lg">关闭</button>
            </div>
        </div>
    </div>


    <!-- 通知模态框 -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4"><div class="bg-slate-800 rounded-lg p-8 shadow-2xl max-w-md w-full border border-slate-600"><h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3><div id="modal-message" class="text-slate-300 mb-6 break-words"></div><button id="modal-close-button" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-6 rounded-lg">关闭</button></div></div>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM & 视图管理 ---
        const views = { 
            main: document.getElementById('main-view'), 
            chat: document.getElementById('chat-view'), 
            prd: document.getElementById('prd-view'), 
            experience: document.getElementById('experience-view') 
        };
        const experiencePages = { 4: document.getElementById('experience-prototype-page'), 5: document.getElementById('experience-quotation-page') };
        
        // --- DOM 元素引用 ---
        const initialIdeaInput = document.getElementById('initial-idea-input'), startChatButton = document.getElementById('start-chat-button');
        const chatWindow = document.getElementById('chat-window'), chatInput = document.getElementById('chat-input'), sendChatButton = document.getElementById('send-chat-button'), aiThinkingIndicator = document.getElementById('ai-thinking-indicator'), finishChatButton = document.getElementById('finish-chat-button');
        const generatedPrdDiv = document.getElementById('generated-prd'), analyzeMarketButton = document.getElementById('analyze-market-button'), exportPdfButton = document.getElementById('export-pdf-button'), goToExperienceViewButton = document.getElementById('go-to-experience-view-button');
        const generateUserStoriesButton = document.getElementById('generate-user-stories-button'), generateBomButton = document.getElementById('generate-bom-button');
        const backToMainFromChat = document.getElementById('back-to-main-from-chat'), backToChat = document.getElementById('back-to-chat'), backToPrd = document.getElementById('back-to-prd');
        const appearanceKeywordTextarea = document.getElementById('appearance-keyword-textarea'), generateAppearanceButton = document.getElementById('generate-appearance-button'), sceneImageLoader = document.getElementById('scene-image-loader'), sceneProductImage = document.getElementById('scene-product-image');
        const personaTextarea = document.getElementById('persona-textarea'), applyPersonaButton = document.getElementById('apply-persona-button'), demoChatWindow = document.getElementById('demo-chat-window'), demoAiThinkingIndicator = document.getElementById('demo-ai-thinking-indicator'), demoChatInput = document.getElementById('demo-chat-input'), demoSendChatButton = document.getElementById('demo-send-chat-button'), emotionScreen = document.getElementById('emotion-screen'), emotionSelector = document.getElementById('emotion-selector');
        const goToQuotationButton = document.getElementById('go-to-quotation-button');
        const quotationForm = document.getElementById('quotation-form'), quotationSuccessMessage = document.getElementById('quotation-success-message');
        const userAdditionalRequirements = document.getElementById('user-additional-requirements');
        const modal = document.getElementById('notification-modal'), modalTitle = document.getElementById('modal-title'), modalMessage = document.getElementById('modal-message'), modalCloseButton = document.getElementById('modal-close-button');
        const startCreationLink = document.getElementById('start-creation-link');
        const openPromptHelperBtn = document.getElementById('open-prompt-helper');
        const promptHelperModal = document.getElementById('prompt-helper-modal');
        const promptHelperInput = document.getElementById('prompt-helper-input');
        const promptHelperGenerateBtn = document.getElementById('prompt-helper-generate-btn');
        const promptHelperOutputContainer = document.getElementById('prompt-helper-output-container');
        const promptHelperOutput = document.getElementById('prompt-helper-output');
        const promptHelperApplyBtn = document.getElementById('prompt-helper-apply-btn');
        const promptHelperCloseBtn = document.getElementById('prompt-helper-close-btn');

        // --- API 配置 ---
        const OPENAI_API_KEY = "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";
        const GOOGLE_API_KEY = "AIzaSyDJH7WRf67xuKh-qNCkoFqc3mCbREEZdns";
        const GOOGLE_GEMINI_STREAM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:streamGenerateContent?key=${GOOGLE_API_KEY}`;
        const GOOGLE_GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GOOGLE_API_KEY}`;
        const OPENAI_IMAGE_API_URL = 'https://api.openai.com/v1/images/generations';
        const OPENAI_TTS_API_URL = 'https://api.openai.com/v1/audio/speech';

        // --- 状态管理 ---
        let chatHistory = [];
        let demoChatHistory = [];
        let finalProductPRD = "";
        let currentStep = 1;
        const defaultPRD = "这是一款AI智能咖啡机。其目标用户是追求高品质生活的年轻专业人士。核心功能包括通过语音命令或移动应用程序定制咖啡的浓度、温度和奶泡量。它还能学习用户偏好并主动推荐咖啡。在设计上，它拥有时尚的金属外观和一块小巧的触摸交互屏。";
        let isMainImageGenerated = false;

        // --- 流程控制 ---
        function showView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.toggle('active', key === viewName);
            });
            window.scrollTo(0,0);
        }

        function updateStepUI(step) {
            currentStep = step;
            for (let i = 1; i <= 5; i++) {
                const icon = document.getElementById(`step-icon-${i}`);
                if (icon) {
                    icon.classList.toggle('active', i <= currentStep);
                }
            }
        }
        
        function showStep(step) {
            updateStepUI(step);
            if (step === 1) showView('main');
            else if (step === 2) showView('chat');
            else if (step === 3) showView('prd');
            else if (step === 4 || step === 5) {
                showView('experience');
                Object.values(experiencePages).forEach(p => p.classList.add('hidden'));
                if(experiencePages[step]) experiencePages[step].classList.remove('hidden');
            }
        }

        document.querySelectorAll('.step-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const targetStep = parseInt(link.id.split('-')[2], 10);
                if (targetStep === 4) {
                    setupExperienceView(true); // isDemo = true
                    return;
                }
                if (targetStep <= currentStep) {
                    showStep(targetStep);
                } else {
                    showNotification("流程提示", "请按顺序完成当前步骤后，才能访问后续流程。");
                }
            });
        });

        // --- 工具函数 ---
        function showNotification(title, message) { 
            modalTitle.textContent = title; 
            modalMessage.innerHTML = message; 
            modal.classList.remove('hidden'); 
        }
        function appendMessage(windowEl, sender, text) { 
            const container = document.createElement('div'); 
            const bubble = document.createElement('div'); 
            bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`; 
            bubble.innerHTML = marked.parse(text); 
            container.appendChild(bubble); 
            windowEl.appendChild(container); 
            bubble.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return bubble; 
        }
        function setChatUiLock(isLocked, chatInputEl, sendButtonEl, thinkingIndicatorEl) { 
            chatInputEl.disabled = isLocked; 
            sendButtonEl.disabled = isLocked; 
            thinkingIndicatorEl.classList.toggle('hidden', !isLocked); 
        }

        function formatGoogleHistory(history) {
            return history.map(item => ({
                role: item.role === 'assistant' ? 'model' : 'user',
                parts: [{ text: item.content }]
            })).filter(item => item.parts[0].text.trim() !== '');
        }

        async function playAudio(text) {
            try {
                const response = await fetch(OPENAI_TTS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'tts-1-hd',
                        input: text,
                        voice: 'nova'
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `OpenAI TTS API 请求失败: ${response.status}`);
                }
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            } catch (error) {
                console.error("音频播放失败:", error);
                showNotification('音频播放失败', `无法播放AI语音: ${error.message}`);
            }
        }

        async function callGoogleTextApi({history, elementToUpdate, isStream = false, withTTS = false}) {
            const apiUrl = isStream ? GOOGLE_GEMINI_STREAM_API_URL : GOOGLE_GEMINI_API_URL;
            let loadingBubble;
            const payload = { contents: formatGoogleHistory(history) };

            if (isStream && elementToUpdate) {
                if (elementToUpdate.id === 'chat-window' || elementToUpdate.id === 'demo-chat-window') {
                    loadingBubble = appendMessage(elementToUpdate, 'assistant', '');
                } else {
                    loadingBubble = elementToUpdate;
                    loadingBubble.innerHTML = '';
                }
            } else if (elementToUpdate) {
                 elementToUpdate.innerHTML = '<div class="flex items-center justify-center gap-3"><div class="loader"></div><p>AI 正在生成内容...</p></div>';
            }
            
            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `Google API 请求失败: ${response.status}`);
                }
                
                let fullResponse = "";

                if (isStream) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        try {
                             const chunk = decoder.decode(value);
                             const lines = chunk.split('\n');
                             for(const line of lines) {
                                if (line.trim().startsWith('"text":')) {
                                    const textPart = JSON.parse(`{${line}}`).text;
                                    fullResponse += textPart;
                                }
                             }
                        } catch(e) { /* Ignore parsing errors from incomplete chunks */ }

                        if(loadingBubble) {
                            loadingBubble.innerHTML = marked.parse(fullResponse);
                            loadingBubble.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                    }
                     if(loadingBubble) {
                        loadingBubble.innerHTML = marked.parse(fullResponse);
                        loadingBubble.scrollIntoView({ behavior: 'smooth', block: 'end' });
                     }

                } else { // Non-streaming
                    const result = await response.json();
                    fullResponse = result.candidates[0]?.content?.parts[0]?.text || '';
                    if (elementToUpdate) {
                       elementToUpdate.innerHTML = marked.parse(fullResponse);
                    }
                }
                
                if (withTTS && fullResponse) {
                    await playAudio(fullResponse);
                }

                return fullResponse;

            } catch (error) {
                const errorMessage = `与Google API通信时发生错误: ${error.message}`;
                if (loadingBubble) { loadingBubble.innerHTML = `<p class="text-red-400">${errorMessage}</p>`; } 
                else if (elementToUpdate) { elementToUpdate.innerHTML = `<p class="text-red-400">${errorMessage}</p>`; }
                showNotification('API 通信错误', errorMessage);
                return null;
            }
        }
        
        async function callOpenAIImageApi(prompt, loaderElement, imageElement) {
            loaderElement.classList.remove('hidden');
            if(imageElement) imageElement.style.opacity = '0.5';

            try {
                const response = await fetch(OPENAI_IMAGE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: prompt,
                        n: 1,
                        size: "1792x1024",
                        response_format: "b64_json"
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `DALL-E 3 API 请求失败`);
                }
                const result = await response.json();
                const b64_json = result.data[0].b64_json;
                if (b64_json) {
                    const imageUrl = `data:image/png;base64,${b64_json}`;
                    if(imageElement) {
                        imageElement.src = imageUrl;
                        isMainImageGenerated = true;
                    }
                    return imageUrl;
                } else {
                    throw new Error('未能从OpenAI API获取有效图片数据。');
                }
            } catch (error) {
                showNotification('图像生成失败', `与 DALL-E 3 通信时发生错误: ${error.message}`);
                if (imageElement) imageElement.src = `https://placehold.co/1792x1024/0f172a/9ca3af?text=生成失败`;
            } finally {
                loaderElement.classList.add('hidden');
                if(imageElement) imageElement.style.opacity = '1';
            }
        }

        // --- 核心逻辑 ---
        function initializeChat() {
            const userInput = initialIdeaInput.value.trim();
            if (!userInput) { showNotification('输入错误', '请输入您的初步构想以开始对话。'); return; }
            showStep(2);
            const systemPrompt = `你是一名资深的AI硬件产品经理。你的任务是通过多轮对话，引导用户明确他们的产品构想。你的回复应该简短、友好、专业。请使用Markdown的粗体格式（例如 **关键词**）来高亮你认为重要的产品特性、用户需求或关键决策点，这些内容将被用颜色强调出来。`;
            chatHistory = [ { role: "system", content: systemPrompt } ];
            appendMessage(chatWindow, 'user', userInput);
            chatHistory.push({ role: "user", content: userInput });
            getAiResponse();
        }
        
        async function getAiResponse() {
            setChatUiLock(true, chatInput, sendChatButton, aiThinkingIndicator);
            const responseText = await callGoogleTextApi({
                history: chatHistory, 
                elementToUpdate: chatWindow, 
                isStream: true, 
                withTTS: false
            });
            if (responseText) {
                chatHistory.push({ role: "assistant", content: responseText });
            }
            setChatUiLock(false, chatInput, sendChatButton, aiThinkingIndicator); 
            chatInput.focus();
        }
        
        async function handleSendMessage() { 
            const userInput = chatInput.value.trim(); 
            if (!userInput) return; 
            appendMessage(chatWindow, 'user', userInput); 
            chatHistory.push({ role: "user", content: userInput }); 
            chatInput.value = ''; 
            await getAiResponse(); 
        }
        
        async function handleGeneratePRD() { 
            showStep(3);
            const finalPrompt = `根据我们之前完整的对话记录，请总结并生成一份专业、详细、结构化的最终产品需求文档（PRD）。如果信息不足，请根据产品经理的专业知识，围绕初始构想进行合理的扩充和补完，确保文档的完整性。请包含：产品概述、目标用户群体、产品功能需求（含优先级）、非功能性需求、产品形态与设计建议。使用Markdown格式，不要包含任何额外对话。`; 
            const messages = [...chatHistory, {role: 'user', content: finalPrompt}];
            finalProductPRD = await callGoogleTextApi({
                history: messages, 
                elementToUpdate: generatedPrdDiv, 
                isStream: true, 
                withTTS: false
            }) || "";
        }
        
        async function handleSectionGeneration(button, promptTemplate, sectionTitle) {
            button.disabled = true;
            button.innerHTML = '<div class="loader inline-block"></div> 正在生成...';
            const prdContent = generatedPrdDiv.innerText;
            if (!prdContent) {
                showNotification("错误", "PRD内容为空，请先生成主文档。");
                button.disabled = false;
                button.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>生成失败`;
                return;
            }
            
            const prompt = promptTemplate.replace('${PRD_CONTENT}', prdContent);
            
            const sectionContainer = document.createElement('div');
            sectionContainer.innerHTML = `<hr class="my-8 border-dashed border-slate-600">`;
            const contentDiv = document.createElement('div');
            sectionContainer.appendChild(contentDiv);
            generatedPrdDiv.appendChild(sectionContainer);

            const newText = await callGoogleTextApi({
                history: [{role: 'user', content: prompt}], 
                elementToUpdate: contentDiv, 
                isStream: true, 
                withTTS: false
            });

            if (newText) {
                finalProductPRD += `\n\n---\n\n${newText}`;
                button.innerHTML = `<i class="fas fa-check mr-2"></i>已生成 ${sectionTitle}`;
            } else {
                button.innerHTML = `<i class="fas fa-times mr-2"></i>生成失败`;
            }
            button.disabled = false;
        }

        async function handleMarketAnalysis() { await handleSectionGeneration(analyzeMarketButton, `基于以下这份PRD，为我生成一份专业的市场分析报告，包含市场规模预估、目标用户画像、主要竞争对手分析和SWOT分析。请直接以Markdown的二级标题（## 市场潜力分析）开始，不要包含任何前言。PRD全文如下：\n\${PRD_CONTENT}`, "市场潜力分析"); }
        async function handleGenerateUserStories() { await handleSectionGeneration(generateUserStoriesButton, `基于以下这份PRD，为我生成至少5个详细的用户故事（User Stories），遵循“作为一个<用户角色>，我想要<完成某个功能>，以便于<实现某种价值>”的格式。请直接以Markdown的二级标题（## 用户故事）开始，不要包含任何前言。PRD全文如下：\n\${PRD_CONTENT}`, "用户故事"); }
        async function handleGenerateBOM() { await handleSectionGeneration(generateBomButton, `基于以下这份PRD，为我生成一份预估的物料清单（BOM），列出关键硬件组件（如主控芯片、传感器、显示屏、电池等）的可能型号和预估数量。请直接以Markdown的二级标题（## 物料清单 (BOM)）开始，不要包含任何前言。PRD全文如下：\n\${PRD_CONTENT}`, "物料清单 (BOM)"); }
        
        async function setupExperienceView(isDemo = false) { 
            let prdToUse = finalProductPRD;
            if (isDemo && !finalProductPRD) {
                prdToUse = defaultPRD;
            } else if (!finalProductPRD) {
                 showNotification("错误", "请先生成PRD文档。"); 
                 return;
            }
            
            showStep(4);
            personaTextarea.value = "正在提取AI角色提示词..."; 
            appearanceKeywordTextarea.value = "正在提取产品外观关键词...";
            
            const personaPrompt = `从以下PRD中，为产品的AI助手创建一个角色定义和系统提示词。这个定义需要清晰、简洁，包含它的性格、说话风格和主要任务。请直接输出角色定义的文本，不要包含任何其他对话。PRD内容：\n\n${prdToUse}`; 
            callGoogleTextApi({history: [{role:'user', content: personaPrompt}]}).then(text => { if(text) personaTextarea.value = text; });
            
            const scenePrompt = `根据以下产品需求文档(PRD)，提取一系列用于AI图像生成的、描述产品外观的关键词（支持中文）。请仅用逗号分隔这些关键词。不要包含任何其他文字。PRD：\n\n${prdToUse}`; 
            callGoogleTextApi({history: [{role:'user', content: scenePrompt}]}).then(text => { if(text) appearanceKeywordTextarea.value = text; }); 
        }
        
        async function generateProductImage() {
            const productKeywords = appearanceKeywordTextarea.value.trim();
            if (!productKeywords) { showNotification("错误", "产品外观关键词不能为空。"); return; }
            const finalPrompt = `${productKeywords}, product photography, studio shot, on a clean white background, minimalist, no logo, no branding, no props, professional studio lighting, soft shadows, photorealistic`;
            await callOpenAIImageApi(finalPrompt, sceneImageLoader, sceneProductImage);
        }

        async function applyAndStartPersona() { 
            const personaPrompt = personaTextarea.value.trim();
            if (!personaPrompt) {showNotification("错误", "AI角色提示词不能为空。"); return;} 
            demoChatHistory = [{ role: "system", content: personaPrompt }]; 
            demoChatWindow.innerHTML = ''; 
            
            let prdToUse = finalProductPRD || defaultPRD;
            const openingLinePrompt = `Based on the following PRD, create a natural, engaging opening line for a user to start a conversation with the product's AI assistant. The line should be from the user's perspective. Output only the opening line text. PRD:\n\n${prdToUse}`;
            const openingLine = await callGoogleTextApi({history: [{ role: 'user', content: openingLinePrompt }]});

            if (openingLine) {
                appendMessage(demoChatWindow, 'user', openingLine); 
                demoChatHistory.push({ role: "user", content: openingLine });
                await getDemoAiResponse();
            } else {
                showNotification("错误", "无法生成开场白。");
            }
        }

        async function analyzeEmotion(text) {
            const prompt = `分析以下文本的情绪。请只用一个最能代表该情绪的表情符号来回应。例如，如果文本是开心的，就回应“😊”。如果是悲伤的，就回应“😢”。如果是提供帮助或信息的，就回应“💡”。如果是惊讶的，用“😮”。如果是简单的确认，用“🙂”。不要包含任何其他文字或解释。文本是：“${text}”`;
            const emoji = await callGoogleTextApi({history: [{ role: 'user', content: prompt }]});
            emotionScreen.textContent = emoji || '🙂';
        }
        
        async function getDemoAiResponse() {
            setChatUiLock(true, demoChatInput, demoSendChatButton, demoAiThinkingIndicator);
            const responseText = await callGoogleTextApi({
                history: demoChatHistory, 
                elementToUpdate: demoChatWindow, 
                isStream: true, 
                withTTS: true
            });
            if(responseText) { 
                demoChatHistory.push({ role: "assistant", content: responseText });
                analyzeEmotion(responseText);
            }
            setChatUiLock(false, demoChatInput, demoSendChatButton, demoAiThinkingIndicator);
        }

        async function handleDemoChatSend() { 
            const userInput = demoChatInput.value.trim(); if (!userInput) return; 
            appendMessage(demoChatWindow, 'user', userInput); 
            demoChatHistory.push({ role: "user", content: userInput });
            demoChatInput.value = '';
            await getDemoAiResponse();
        }
        
        // --- 初始化事件监听器 ---
        showStep(1); 
        startChatButton.onclick = initializeChat; 
        sendChatButton.onclick = handleSendMessage; 
        chatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } };
        finishChatButton.onclick = handleGeneratePRD; 
        analyzeMarketButton.onclick = handleMarketAnalysis; 
        generateUserStoriesButton.onclick = handleGenerateUserStories;
        generateBomButton.onclick = handleGenerateBOM;
        exportPdfButton.onclick = () => {
             showNotification("功能待开发", "导出PDF功能正在开发中。");
             console.log("Export PDF clicked");
        };
        goToExperienceViewButton.onclick = () => setupExperienceView(false); 
        backToMainFromChat.onclick = () => showStep(1);
        backToChat.onclick = () => showStep(2);
        backToPrd.onclick = () => showStep(3);
        
        generateAppearanceButton.onclick = generateProductImage;
        
        applyPersonaButton.onclick = applyAndStartPersona;
        demoSendChatButton.onclick = handleDemoChatSend; 
        demoChatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleDemoChatSend(); } };
        goToQuotationButton.onclick = () => showStep(5);
        
        openPromptHelperBtn.addEventListener('click', () => {
            promptHelperModal.classList.remove('hidden');
        });

        promptHelperCloseBtn.addEventListener('click', () => {
            promptHelperModal.classList.add('hidden');
        });
        
        promptHelperGenerateBtn.addEventListener('click', async () => {
            const userInput = promptHelperInput.value.trim();
            if (!userInput) {
                showNotification("输入为空", "请输入您的产品外观描述。");
                return;
            }

            const loader = promptHelperGenerateBtn.querySelector('.loader');
            const btnText = promptHelperGenerateBtn.querySelector('.btn-text');
            loader.classList.remove('hidden');
            btnText.textContent = "生成中...";
            promptHelperGenerateBtn.disabled = true;

            const systemPrompt = `From the user's description, extract a concise, comma-separated list of the most essential English keywords for an AI image generator like DALL-E 3. Focus on core visual attributes. Be brief. User's description: "${userInput}"`;
            
            const generatedPrompt = await callGoogleTextApi({ history: [{ role: 'user', content: systemPrompt }] });
            
            if (generatedPrompt) {
                promptHelperOutput.textContent = generatedPrompt;
                promptHelperOutputContainer.classList.remove('hidden');
                promptHelperApplyBtn.disabled = false;
            } else {
                showNotification("生成失败", "无法从您的描述生成提示词。");
            }
            
            loader.classList.add('hidden');
            btnText.textContent = "自动生成提示词";
            promptHelperGenerateBtn.disabled = false;
        });

        promptHelperApplyBtn.addEventListener('click', () => {
            const currentKeywords = appearanceKeywordTextarea.value.trim();
            const newKeywords = promptHelperOutput.textContent.trim();
            if (currentKeywords && newKeywords) {
                appearanceKeywordTextarea.value = currentKeywords + ', ' + newKeywords;
            } else if (newKeywords) {
                appearanceKeywordTextarea.value = newKeywords;
            }
            promptHelperModal.classList.add('hidden');
        });

        quotationForm.addEventListener('submit', (e) => {
             e.preventDefault(); 
             
             // 整合所有项目信息
             const finalDocument = `
# 最终项目需求文档

## 1. 用户联系方式
- **邮箱:** ${document.getElementById('user-email').value}
- **其他联系方式:** ${document.getElementById('user-contact').value}

---

## 2. 产品需求文档 (PRD)
${generatedPrdDiv.innerText}

---

## 3. AI 角色设定
\`\`\`
${personaTextarea.value}
\`\`\`

---

## 4. 产品外观生成关键词
\`\`\`
${appearanceKeywordTextarea.value}
\`\`\`

---

## 5. 用户补充说明
${userAdditionalRequirements.value}

---

## 6. 产品效果图
**图片Base64源:**
(为保证文档简洁，此处仅引用，实际提交时可包含完整Base64数据)
${sceneProductImage.src.substring(0, 100)}...
             `;

            const submissionPackage = {
                contactInfo: { 
                    email: document.getElementById('user-email').value, 
                    other: document.getElementById('user-contact').value 
                },
                fullDocument: finalDocument,
                submissionTimestamp: new Date().toISOString()
            };
            
            // 此处应为发送到后端的逻辑
            console.log("项目报价资料已打包 (模拟发送):", submissionPackage);

            document.getElementById('quotation-form-container').classList.add('hidden');
            quotationSuccessMessage.classList.remove('hidden'); 
        });
        modalCloseButton.onclick = () => modal.classList.add('hidden');
        startCreationLink.onclick = (e) => { e.preventDefault(); document.querySelector('#creation-process').scrollIntoView({ behavior: 'smooth' }); };

        // 初始化情绪选择器
        const emotions = ['🙂', '😊', '💡', '🤔', '😂', '😮', '😢', '👍', '😍'];
        emotionSelector.innerHTML = '';
        emotions.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emotion-choice';
            span.textContent = emoji;
            span.onclick = () => { emotionScreen.textContent = emoji; };
            emotionSelector.appendChild(span);
        });
    });
    </script>
</body>
</html>
